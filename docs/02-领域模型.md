# 化债核心域 - 领域模型设计

> 版本: v1.0
> 日期: 2025-11-27

---

## 1. 值对象 (Value Objects)

### 1.1 Money - 金额

```java
/**
 * 金额值对象
 *
 * 不可变对象，所有运算返回新实例
 */
@Value
public class Money {

    BigDecimal amount;

    public static final Money ZERO = new Money(BigDecimal.ZERO);

    public Money(BigDecimal amount) {
        if (amount == null) {
            throw new IllegalArgumentException("金额不能为空");
        }
        // 保留2位小数，四舍五入
        this.amount = amount.setScale(2, RoundingMode.HALF_UP);
    }

    public static Money of(BigDecimal amount) {
        return new Money(amount);
    }

    public static Money of(String amount) {
        return new Money(new BigDecimal(amount));
    }

    public Money add(Money other) {
        return new Money(this.amount.add(other.amount));
    }

    public Money subtract(Money other) {
        return new Money(this.amount.subtract(other.amount));
    }

    public Money negate() {
        return new Money(this.amount.negate());
    }

    public boolean isGreaterThan(Money other) {
        return this.amount.compareTo(other.amount) > 0;
    }

    public boolean isZero() {
        return this.amount.compareTo(BigDecimal.ZERO) == 0;
    }

    public boolean isPositive() {
        return this.amount.compareTo(BigDecimal.ZERO) > 0;
    }

    /**
     * 取两者中较小的值
     */
    public Money min(Money other) {
        return this.isGreaterThan(other) ? other : this;
    }
}
```

### 1.2 OrderId - 订单标识

```java
/**
 * 订单ID值对象
 *
 * 商城订单号，字符串类型
 */
@Value
public class OrderId {

    String value;

    public OrderId(String value) {
        if (value == null || value.isBlank()) {
            throw new IllegalArgumentException("订单号不能为空");
        }
        this.value = value;
    }

    public static OrderId of(String value) {
        return new OrderId(value);
    }
}
```

### 1.3 Period - 期数(年月)

```java
/**
 * 期数值对象
 *
 * 表示还款计划的期数，格式为年月
 */
@Value
public class Period {

    YearMonth value;

    public Period(YearMonth value) {
        if (value == null) {
            throw new IllegalArgumentException("期数不能为空");
        }
        this.value = value;
    }

    public static Period of(int year, int month) {
        return new Period(YearMonth.of(year, month));
    }

    public static Period of(YearMonth yearMonth) {
        return new Period(yearMonth);
    }

    /**
     * 从日期时间解析期数
     */
    public static Period fromDateTime(LocalDateTime dateTime) {
        return new Period(YearMonth.from(dateTime));
    }

    /**
     * 从字符串解析 (格式: yyyy-MM-dd HH:mm:ss)
     */
    public static Period fromString(String dateTimeStr) {
        DateTimeFormatter formatter = DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss");
        LocalDateTime dateTime = LocalDateTime.parse(dateTimeStr, formatter);
        return fromDateTime(dateTime);
    }

    public String toDbFormat() {
        return value.format(DateTimeFormatter.ofPattern("yyyy-MM"));
    }
}
```

---

## 2. 枚举类型

### 2.1 ContractStatus - 合同状态

```java
/**
 * 合同状态枚举
 */
public enum ContractStatus {

    /** 履约中 */
    IN_PERFORMANCE("in_performance", "履约中"),

    /** 已完成(债务清零) */
    COMPLETED("completed", "已完成"),

    /** 已终止 */
    TERMINATED("terminated", "已终止");

    private final String code;
    private final String desc;
}
```

### 2.2 RecordType - 明细类型

```java
/**
 * 化债明细类型
 */
public enum RecordType {

    /** 收入(化债) */
    INCOME(0, "收入"),

    /** 支出(退款回滚) */
    EXPENSE(1, "支出");

    private final Integer code;
    private final String desc;
}
```

### 2.3 RefundStatus - 退款状态

```java
/**
 * 退款状态
 */
public enum RefundStatus {

    /** 未退款 */
    NONE(0, "未退款"),

    /** 申请中 */
    APPLYING(1, "申请中"),

    /** 部分退款 */
    PARTIAL(2, "部分退款"),

    /** 已退款 */
    REFUNDED(3, "已退款");

    private final Integer code;
    private final String desc;
}
```

### 2.4 DivideStatus - 分账状态

```java
/**
 * 分账状态
 */
public enum DivideStatus {

    /** 待分账 */
    PENDING(0, "待分账"),

    /** 已分账 */
    COMPLETED(1, "已分账"),

    /** 分账失败 */
    FAILED(2, "分账失败");

    private final Integer code;
    private final String desc;
}
```

### 2.5 MerType - 商户类型

```java
/**
 * 商户类型(分账接收方)
 */
public enum MerType {

    /** 供应商 */
    SUPPLIER(0, "供应商"),

    /** 债务人 */
    DEBTOR(1, "债务人");

    private final Integer code;
    private final String desc;
}
```

---

## 3. 实体 (Entities)

### 3.1 RepaymentPlan - 还款计划

```java
/**
 * 还款计划实体
 *
 * 属于 DebtContract 聚合内部实体，不能独立存在
 */
@Getter
public class RepaymentPlan {

    /** 计划ID */
    private Long id;

    /** 所属合同ID */
    private Long contractId;

    /** 期数(年月) */
    private Period period;

    /** 计划还款金额 */
    private Money planAmount;

    /** 实际还款金额 */
    private Money actualAmount;

    /**
     * 增加实际还款金额
     */
    public void addActualAmount(Money delta) {
        this.actualAmount = this.actualAmount.add(delta);
    }

    /**
     * 减少实际还款金额(退款回滚)
     */
    public void subtractActualAmount(Money delta) {
        this.actualAmount = this.actualAmount.subtract(delta);
        // 防止出现负数
        if (!this.actualAmount.isPositive() && !this.actualAmount.isZero()) {
            this.actualAmount = Money.ZERO;
        }
    }

    /**
     * 是否完成本期计划
     */
    public boolean isCompleted() {
        return !actualAmount.isGreaterThan(planAmount) == false
            || actualAmount.equals(planAmount);
    }
}
```

### 3.2 RepaymentRecord - 化债明细

```java
/**
 * 化债明细实体
 *
 * 记录每一笔化债或回滚操作
 */
@Getter
public class RepaymentRecord {

    /** 明细ID */
    private Long id;

    /** 所属合同ID */
    private Long contractId;

    /** 委案ID */
    private Long caseEntrustId;

    /** 还款计划ID(可空，期数匹配不到时为空) */
    private Long repaymentPlanId;

    /** 会员用户ID */
    private Long memberUserId;

    /** 订单号 */
    private OrderId orderId;

    /** 商品明细ID(可空，兼容订单级) */
    private Long orderDetailId;

    /** 金额(绝对值) */
    private Money amount;

    /** 类型: 0收入 1支出 */
    private RecordType type;

    /** 描述 */
    private String description;

    /** 退款状态 */
    private RefundStatus refundStatus;

    /**
     * 创建化债记录(收入)
     */
    public static RepaymentRecord createIncome(Long contractId, Long caseEntrustId,
            Long repaymentPlanId, Long memberUserId, OrderId orderId,
            Long orderDetailId, Money amount, String description) {

        RepaymentRecord record = new RepaymentRecord();
        record.contractId = contractId;
        record.caseEntrustId = caseEntrustId;
        record.repaymentPlanId = repaymentPlanId;
        record.memberUserId = memberUserId;
        record.orderId = orderId;
        record.orderDetailId = orderDetailId;
        record.amount = amount;
        record.type = RecordType.INCOME;
        record.description = description;
        record.refundStatus = RefundStatus.NONE;
        return record;
    }

    /**
     * 创建退款记录(支出)
     */
    public static RepaymentRecord createExpense(Long contractId, Long caseEntrustId,
            Long repaymentPlanId, Long memberUserId, OrderId orderId,
            Long orderDetailId, Money amount, String description, RefundStatus refundStatus) {

        RepaymentRecord record = new RepaymentRecord();
        record.contractId = contractId;
        record.caseEntrustId = caseEntrustId;
        record.repaymentPlanId = repaymentPlanId;
        record.memberUserId = memberUserId;
        record.orderId = orderId;
        record.orderDetailId = orderDetailId;
        record.amount = amount;
        record.type = RecordType.EXPENSE;
        record.description = "[退款]" + description;
        record.refundStatus = refundStatus;
        return record;
    }
}
```

---

## 4. 聚合根 (Aggregate Roots)

### 4.1 DebtContract - 化债合同

```java
/**
 * 化债合同聚合根
 *
 * 核心职责:
 * 1. 管理债务金额(总额、已化债、剩余)
 * 2. 管理还款计划
 * 3. 执行化债和回滚操作
 * 4. 维护化债明细
 */
@Getter
public class DebtContract {

    // ============ 基本属性 ============

    /** 合同ID */
    private Long id;

    /** 委案ID(跨聚合引用) */
    private Long caseEntrustId;

    /** 会员用户ID */
    private Long memberUserId;

    /** 总债务金额 */
    private Money totalDebtAmount;

    /** 已化债金额 */
    private Money settledAmount;

    /** 剩余债务金额 */
    private Money remainingAmount;

    /** 合同状态 */
    private ContractStatus status;

    // ============ 内部实体集合 ============

    /** 还款计划列表 */
    private List<RepaymentPlan> repaymentPlans;

    /** 化债明细列表(仅用于新增，查询走Repository) */
    private List<RepaymentRecord> pendingRecords = new ArrayList<>();

    // ============ 领域事件 ============

    private List<DomainEvent> domainEvents = new ArrayList<>();

    // ============ 核心行为 ============

    /**
     * 执行化债
     *
     * @param amount 化债金额
     * @param orderId 订单号
     * @param orderDetailId 商品明细ID(可空)
     * @param orderCreateTime 订单创建时间(用于匹配期数)
     * @param description 描述
     * @return 化债明细记录
     */
    public RepaymentRecord settle(Money amount, OrderId orderId, Long orderDetailId,
                                   String orderCreateTime, String description) {
        // 1. 校验合同状态
        assertCanSettle();

        // 2. 计算实际化债金额(不能超过剩余债务)
        Money actualAmount = amount.min(this.remainingAmount);

        // 3. 更新合同金额
        this.settledAmount = this.settledAmount.add(actualAmount);
        this.remainingAmount = this.remainingAmount.subtract(actualAmount);

        // 4. 匹配并更新还款计划
        Long repaymentPlanId = updateRepaymentPlanForSettle(orderCreateTime, actualAmount);

        // 5. 检查是否完成
        if (this.remainingAmount.isZero()) {
            this.status = ContractStatus.COMPLETED;
            // 发布合同完成事件
            domainEvents.add(new ContractCompletedEvent(this.id, this.memberUserId));
        }

        // 6. 创建化债明细
        RepaymentRecord record = RepaymentRecord.createIncome(
            this.id, this.caseEntrustId, repaymentPlanId,
            this.memberUserId, orderId, orderDetailId, actualAmount, description
        );
        this.pendingRecords.add(record);

        // 7. 发布化债完成事件
        domainEvents.add(new DebtSettledEvent(this.id, orderId.getValue(), actualAmount));

        return record;
    }

    /**
     * 执行化债回滚
     */
    public RepaymentRecord rollback(Money amount, OrderId orderId, Long orderDetailId,
                                     String orderCreateTime, String description,
                                     RefundStatus refundStatus) {
        // 1. 恢复合同金额
        this.settledAmount = this.settledAmount.subtract(amount);
        this.remainingAmount = this.remainingAmount.add(amount);

        // 2. 匹配并恢复还款计划
        Long repaymentPlanId = updateRepaymentPlanForRollback(orderCreateTime, amount);

        // 3. 状态回退(如果之前是已完成)
        if (this.status == ContractStatus.COMPLETED) {
            this.status = ContractStatus.IN_PERFORMANCE;
        }

        // 4. 创建退款明细
        RepaymentRecord record = RepaymentRecord.createExpense(
            this.id, this.caseEntrustId, repaymentPlanId,
            this.memberUserId, orderId, orderDetailId, amount, description, refundStatus
        );
        this.pendingRecords.add(record);

        // 5. 发布回滚事件
        domainEvents.add(new DebtRolledBackEvent(this.id, orderId.getValue(), amount, refundStatus));

        return record;
    }

    /**
     * 检查是否可以化债
     */
    public boolean canSettle() {
        return this.status == ContractStatus.IN_PERFORMANCE
            && this.remainingAmount.isPositive();
    }

    // ============ 私有方法 ============

    private void assertCanSettle() {
        if (!canSettle()) {
            throw new DomainException("合同状态不允许化债，当前状态: " + this.status);
        }
    }

    /**
     * 更新还款计划(化债)
     * @return 匹配到的还款计划ID，匹配不到返回null并发布事件
     */
    private Long updateRepaymentPlanForSettle(String orderCreateTime, Money amount) {
        if (orderCreateTime == null || orderCreateTime.isBlank()) {
            return null;
        }

        Period period = Period.fromString(orderCreateTime);
        RepaymentPlan matchedPlan = findRepaymentPlanByPeriod(period);

        if (matchedPlan != null) {
            matchedPlan.addActualAmount(amount);
            return matchedPlan.getId();
        } else {
            // 匹配不到期数，发布领域事件
            domainEvents.add(new RepaymentPlanNotMatchedEvent(
                this.id, period.toDbFormat(), amount
            ));
            return null;
        }
    }

    /**
     * 更新还款计划(回滚)
     */
    private Long updateRepaymentPlanForRollback(String orderCreateTime, Money amount) {
        if (orderCreateTime == null || orderCreateTime.isBlank()) {
            return null;
        }

        Period period = Period.fromString(orderCreateTime);
        RepaymentPlan matchedPlan = findRepaymentPlanByPeriod(period);

        if (matchedPlan != null) {
            matchedPlan.subtractActualAmount(amount);
            return matchedPlan.getId();
        }
        return null;
    }

    private RepaymentPlan findRepaymentPlanByPeriod(Period period) {
        if (repaymentPlans == null) {
            return null;
        }
        return repaymentPlans.stream()
            .filter(plan -> plan.getPeriod().equals(period))
            .findFirst()
            .orElse(null);
    }

    // ============ 领域事件处理 ============

    public List<DomainEvent> getDomainEvents() {
        return Collections.unmodifiableList(domainEvents);
    }

    public void clearDomainEvents() {
        this.domainEvents.clear();
    }

    public List<RepaymentRecord> getPendingRecords() {
        return Collections.unmodifiableList(pendingRecords);
    }

    public void clearPendingRecords() {
        this.pendingRecords.clear();
    }
}
```

### 4.2 DivideRecord - 分账记录

```java
/**
 * 分账记录聚合根
 *
 * 核心职责:
 * 1. 管理预分账和实际分账状态
 * 2. 支持商品明细级别的分账记录
 * 3. 提供债务人分账金额查询
 */
@Getter
public class DivideRecord {

    /** 主键 */
    private Long id;

    /** 商城订单号 */
    private OrderId orderId;

    /** 订单总金额 */
    private Money orderAmount;

    /** 易宝批次号 */
    private String yeepayBatchNo;

    /** 分账状态 */
    private DivideStatus status;

    /** 分账明细列表 */
    private List<DivideItem> items;

    // ============ 核心行为 ============

    /**
     * 获取债务人分账总金额
     */
    public Money getDebtorTotalAmount() {
        if (items == null || items.isEmpty()) {
            return Money.ZERO;
        }
        return items.stream()
            .filter(item -> item.getMerType() == MerType.DEBTOR)
            .map(DivideItem::getAmount)
            .reduce(Money.ZERO, Money::add);
    }

    /**
     * 获取指定商品明细的债务人分账金额
     */
    public Money getDebtorAmountByOrderDetailId(Long orderDetailId) {
        if (items == null || items.isEmpty() || orderDetailId == null) {
            return Money.ZERO;
        }
        return items.stream()
            .filter(item -> item.getMerType() == MerType.DEBTOR)
            .filter(item -> orderDetailId.equals(item.getOrderDetailId()))
            .map(DivideItem::getAmount)
            .reduce(Money.ZERO, Money::add);
    }

    /**
     * 标记分账完成
     */
    public void markCompleted(String yeepayBatchNo) {
        this.yeepayBatchNo = yeepayBatchNo;
        this.status = DivideStatus.COMPLETED;
    }

    /**
     * 标记分账失败
     */
    public void markFailed() {
        this.status = DivideStatus.FAILED;
    }

    /**
     * 是否已分账
     */
    public boolean isDivided() {
        return this.status == DivideStatus.COMPLETED;
    }
}

/**
 * 分账明细(实体)
 */
@Getter
public class DivideItem {

    /** 主键 */
    private Long id;

    /** 所属分账记录ID */
    private Long divideRecordId;

    /** 商品明细ID(可空，兼容订单级) */
    private Long orderDetailId;

    /** 商品名称 */
    private String productName;

    /** 分账标识(商户号/unionId) */
    private String ledgerId;

    /** 商户类型 */
    private MerType merType;

    /** 易宝子商户号 */
    private String subMerNo;

    /** 分账金额 */
    private Money amount;
}
```

---

## 5. 领域事件 (Domain Events)

### 5.1 事件清单

```java
/** 化债完成事件 */
@Value
public class DebtSettledEvent implements DomainEvent {
    Long contractId;
    String orderId;
    Money amount;
    LocalDateTime occurredAt = LocalDateTime.now();
}

/** 化债回滚事件 */
@Value
public class DebtRolledBackEvent implements DomainEvent {
    Long contractId;
    String orderId;
    Money amount;
    RefundStatus refundStatus;
    LocalDateTime occurredAt = LocalDateTime.now();
}

/** 合同完成事件(债务清零) */
@Value
public class ContractCompletedEvent implements DomainEvent {
    Long contractId;
    Long memberUserId;
    LocalDateTime occurredAt = LocalDateTime.now();
}

/** 还款计划未匹配事件 */
@Value
public class RepaymentPlanNotMatchedEvent implements DomainEvent {
    Long contractId;
    String period;  // 期数，如 "2025-03"
    Money amount;
    LocalDateTime occurredAt = LocalDateTime.now();
}

/** 分账完成事件 */
@Value
public class DivideCompletedEvent implements DomainEvent {
    Long divideRecordId;
    String orderId;
    String yeepayBatchNo;
    LocalDateTime occurredAt = LocalDateTime.now();
}
```

---

## 6. 领域服务 (Domain Services)

### 6.1 DebtSettlementService - 化债领域服务

```java
/**
 * 化债领域服务
 *
 * 协调分账聚合和化债合同聚合之间的交互
 */
public interface DebtSettlementService {

    /**
     * 执行化债
     *
     * 1. 查询分账记录获取债务人分账金额
     * 2. 查询化债合同
     * 3. 执行化债操作
     *
     * @param orderId 订单号
     * @param orderDetailId 商品明细ID(可空)
     * @param memberUserId 会员用户ID
     * @param orderCreateTime 订单创建时间
     * @param description 描述
     */
    void settle(String orderId, Long orderDetailId, Long memberUserId,
                String orderCreateTime, String description);

    /**
     * 执行化债回滚
     */
    void rollback(String orderId, Long orderDetailId, Long memberUserId,
                  String orderCreateTime, String description, RefundStatus refundStatus);
}
```

### 6.2 DivideAmountQueryService - 分账金额查询服务

```java
/**
 * 分账金额查询服务
 *
 * 跨聚合查询，由分账上下文提供
 */
public interface DivideAmountQueryService {

    /**
     * 查询订单的债务人分账金额
     *
     * @param orderId 订单号
     * @return 债务人分账金额，未找到返回null
     */
    Money getDebtorDivideAmount(String orderId);

    /**
     * 查询商品明细的债务人分账金额
     *
     * @param orderId 订单号
     * @param orderDetailId 商品明细ID
     * @return 债务人分账金额，未找到返回null
     */
    Money getDebtorDivideAmountByDetail(String orderId, Long orderDetailId);
}
```

---

## 7. 仓储接口 (Repositories)

### 7.1 DebtContractRepository

```java
/**
 * 化债合同仓储接口
 */
public interface DebtContractRepository {

    /**
     * 根据ID查询(包含还款计划)
     */
    DebtContract findById(Long id);

    /**
     * 根据委案ID查询履约中的合同
     */
    DebtContract findByCaseEntrustIdAndInPerformance(Long caseEntrustId);

    /**
     * 根据订单号查询关联的合同
     */
    DebtContract findByOrderId(String orderId);

    /**
     * 保存合同(包含还款计划更新、明细插入)
     */
    void save(DebtContract contract);
}
```

### 7.2 DivideRecordRepository

```java
/**
 * 分账记录仓储接口
 */
public interface DivideRecordRepository {

    /**
     * 根据订单号查询
     */
    DivideRecord findByOrderId(String orderId);

    /**
     * 保存分账记录
     */
    void save(DivideRecord record);
}
```

---

## 8. 模型关系图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           化债核心域                                     │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │                    DebtContract 聚合                             │   │
│   │  ┌─────────────────────────────────────────────────────────┐    │   │
│   │  │  DebtContract (聚合根)                                   │    │   │
│   │  │  - id, caseEntrustId, memberUserId                      │    │   │
│   │  │  - totalDebtAmount, settledAmount, remainingAmount      │    │   │
│   │  │  - status: ContractStatus                               │    │   │
│   │  │                                                         │    │   │
│   │  │  + settle(amount, orderId, ...) : RepaymentRecord       │    │   │
│   │  │  + rollback(amount, orderId, ...) : RepaymentRecord     │    │   │
│   │  │  + canSettle() : boolean                                │    │   │
│   │  └─────────────────────────────────────────────────────────┘    │   │
│   │           │                              │                       │   │
│   │           │ 1:N                          │ 1:N                   │   │
│   │           ▼                              ▼                       │   │
│   │  ┌────────────────┐            ┌────────────────────┐           │   │
│   │  │ RepaymentPlan  │            │  RepaymentRecord   │           │   │
│   │  │ - period       │            │  - orderId         │           │   │
│   │  │ - planAmount   │            │  - orderDetailId   │           │   │
│   │  │ - actualAmount │            │  - amount, type    │           │   │
│   │  └────────────────┘            └────────────────────┘           │   │
│   └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │                    DivideRecord 聚合                             │   │
│   │  ┌─────────────────────────────────────────────────────────┐    │   │
│   │  │  DivideRecord (聚合根)                                   │    │   │
│   │  │  - orderId, orderAmount, yeepayBatchNo, status          │    │   │
│   │  │                                                         │    │   │
│   │  │  + getDebtorTotalAmount() : Money                       │    │   │
│   │  │  + getDebtorAmountByOrderDetailId(id) : Money           │    │   │
│   │  │  + markCompleted(batchNo)                               │    │   │
│   │  └─────────────────────────────────────────────────────────┘    │   │
│   │           │                                                      │   │
│   │           │ 1:N                                                  │   │
│   │           ▼                                                      │   │
│   │  ┌─────────────────────────────────────────────────────────┐    │   │
│   │  │  DivideItem                                              │    │   │
│   │  │  - orderDetailId, productName, ledgerId                 │    │   │
│   │  │  - merType, subMerNo, amount                            │    │   │
│   │  └─────────────────────────────────────────────────────────┘    │   │
│   └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │                    值对象                                        │   │
│   │  ┌─────────┐  ┌─────────┐  ┌─────────┐                         │   │
│   │  │  Money  │  │ OrderId │  │ Period  │                         │   │
│   │  └─────────┘  └─────────┘  └─────────┘                         │   │
│   └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 9. 下一步

- [ ] Week 1 Day 5: 上下文映射详细设计
- [ ] Week 2: 应用层设计 (Application Service)
- [ ] Week 2: 基础设施层实现 (Repository实现、防腐层)
