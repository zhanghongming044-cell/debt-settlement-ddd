# 化债核心域 - 应用层设计

> 版本: v1.0
> 日期: 2025-11-27

---

## 1. 应用层职责

应用层是**领域层的门面**，负责：

1. **编排领域对象** - 协调聚合根完成业务用例
2. **事务管理** - 控制事务边界
3. **权限校验** - 调用前的权限检查
4. **DTO转换** - 入参/出参转换
5. **发布领域事件** - 持久化后发布事件
6. **调用防腐层** - 与外部系统交互

**不做的事**：
- ❌ 业务规则判断（放领域层）
- ❌ 数据库操作（放基础设施层）
- ❌ 外部API调用细节（放防腐层）

---

## 2. 命令与查询分离 (CQRS)

### 2.1 命令 (Commands)

```java
/**
 * 执行化债命令
 */
@Data
@Builder
public class SettleDebtCommand {

    /** 订单号 */
    @NotBlank(message = "订单号不能为空")
    private String orderId;

    /** 商品明细ID(可空，兼容订单级) */
    private Long orderDetailId;

    /** 会员用户ID */
    @NotNull(message = "会员用户ID不能为空")
    private Long memberUserId;

    /** unionId(用于查询会员) */
    @NotBlank(message = "unionId不能为空")
    private String unionId;

    /** 订单状态 */
    @NotNull(message = "订单状态不能为空")
    private Integer orderStatus;

    /** 退款状态 */
    @NotNull(message = "退款状态不能为空")
    private Integer refundStatus;

    /** 订单创建时间 */
    private String orderCreateTime;

    /** 描述 */
    private String description;
}

/**
 * 化债回滚命令
 */
@Data
@Builder
public class RollbackDebtCommand {

    /** 订单号 */
    @NotBlank(message = "订单号不能为空")
    private String orderId;

    /** 商品明细ID(可空) */
    private Long orderDetailId;

    /** 会员用户ID */
    @NotNull(message = "会员用户ID不能为空")
    private Long memberUserId;

    /** unionId */
    @NotBlank(message = "unionId不能为空")
    private String unionId;

    /** 退款状态: 2部分退款 3全额退款 */
    @NotNull(message = "退款状态不能为空")
    private Integer refundStatus;

    /** 订单创建时间 */
    private String orderCreateTime;

    /** 描述 */
    private String description;
}

/**
 * 创建预分账命令
 */
@Data
@Builder
public class CreatePreDivideCommand {

    /** 订单号 */
    @NotBlank(message = "订单号不能为空")
    private String orderId;

    /** 订单金额 */
    @NotBlank(message = "订单金额不能为空")
    private String orderAmount;

    /** 分账明细 */
    @NotEmpty(message = "分账明细不能为空")
    private List<DivideItemDTO> divideItems;

    @Data
    public static class DivideItemDTO {
        /** 商品明细ID(可空) */
        private Long orderDetailId;
        /** 商品名称(可空) */
        private String productName;
        /** 分账标识 */
        @NotBlank
        private String ledgerId;
        /** 分账金额 */
        @NotBlank
        private String amount;
        /** 商户类型: 0供应商 1债务人 */
        @NotNull
        private Integer merType;
    }
}
```

### 2.2 查询 (Queries)

```java
/**
 * 查询合同化债进度
 */
@Data
public class ContractProgressQuery {
    /** 合同ID */
    private Long contractId;
    /** 或通过会员ID查询 */
    private Long memberUserId;
}

/**
 * 查询化债明细
 */
@Data
public class RepaymentRecordQuery {
    /** 合同ID */
    private Long contractId;
    /** 分页 */
    private Integer pageNo = 1;
    private Integer pageSize = 20;
}

/**
 * 查询分账金额
 */
@Data
public class DivideAmountQuery {
    /** 订单号 */
    @NotBlank
    private String orderId;
    /** 商户类型: 1债务人 */
    @NotNull
    private Integer merType;
}
```

---

## 3. 应用服务 (Application Services)

### 3.1 DebtSettlementAppService - 化债应用服务

```java
/**
 * 化债应用服务
 *
 * 处理化债相关的所有用例
 */
@Service
@Slf4j
@RequiredArgsConstructor
public class DebtSettlementAppService {

    private final DebtContractRepository contractRepository;
    private final DivideRecordRepository divideRecordRepository;
    private final MemberQueryService memberQueryService;        // 防腐层
    private final CaseEntrustQueryService caseEntrustQueryService;  // 防腐层
    private final DomainEventPublisher eventPublisher;

    /**
     * 执行化债
     *
     * 对应原 OrderServiceImpl.processOrder() 的核心逻辑
     */
    @Transactional(rollbackFor = Exception.class)
    public void settleDebt(SettleDebtCommand command) {
        log.info("[化债] 收到命令: orderId={}, unionId={}", command.getOrderId(), command.getUnionId());

        // 1. 幂等检查
        if (isAlreadySettled(command.getOrderId(), command.getRefundStatus())) {
            log.info("[化债] 订单已处理，跳过: orderId={}", command.getOrderId());
            return;
        }

        // 2. 校验订单状态(只处理确认收货状态)
        if (!isValidOrderStatus(command.getOrderStatus(), command.getRefundStatus())) {
            log.warn("[化债] 订单状态不满足条件: orderStatus={}, refundStatus={}",
                command.getOrderStatus(), command.getRefundStatus());
            throw new BusinessException("订单状态不满足化债条件");
        }

        // 3. 通过unionId查询会员ID (防腐层)
        Long memberUserId = memberQueryService.getMemberUserIdByUnionId(command.getUnionId());
        if (memberUserId == null) {
            throw new BusinessException("未找到会员信息: unionId=" + command.getUnionId());
        }

        // 4. 通过订单号查询委案信息 (防腐层)
        CaseEntrustInfo caseEntrust = caseEntrustQueryService.findByOrderId(command.getOrderId());
        if (caseEntrust == null) {
            throw new BusinessException("未找到委案信息: orderId=" + command.getOrderId());
        }

        // 5. 查询化债合同 (仓储)
        DebtContract contract = contractRepository.findByCaseEntrustIdAndInPerformance(
            caseEntrust.getId()
        );
        if (contract == null) {
            throw new BusinessException("未找到履约中的合同: caseEntrustId=" + caseEntrust.getId());
        }

        // 6. 查询分账金额 (跨聚合查询)
        Money divideAmount = queryDivideAmount(command.getOrderId(), command.getOrderDetailId());
        if (divideAmount == null || !divideAmount.isPositive()) {
            throw new BusinessException("未找到有效的分账金额: orderId=" + command.getOrderId());
        }

        // 7. 执行化债 (领域行为)
        RepaymentRecord record = contract.settle(
            divideAmount,
            OrderId.of(command.getOrderId()),
            command.getOrderDetailId(),
            command.getOrderCreateTime(),
            command.getDescription()
        );

        // 8. 持久化
        contractRepository.save(contract);

        // 9. 发布领域事件
        publishDomainEvents(contract);

        log.info("[化债] 完成: contractId={}, amount={}", contract.getId(), divideAmount);
    }

    /**
     * 执行化债回滚
     */
    @Transactional(rollbackFor = Exception.class)
    public void rollbackDebt(RollbackDebtCommand command) {
        log.info("[化债回滚] 收到命令: orderId={}, refundStatus={}",
            command.getOrderId(), command.getRefundStatus());

        // 1. 幂等检查
        if (isAlreadyRolledBack(command.getOrderId(), command.getRefundStatus())) {
            log.info("[化债回滚] 已处理，跳过: orderId={}", command.getOrderId());
            return;
        }

        // 2. 查询原化债记录，确定要回滚的金额
        RepaymentRecordInfo originalRecord = findOriginalSettleRecord(command.getOrderId());
        if (originalRecord == null) {
            log.info("[化债回滚] 未找到原化债记录，可能未化债，忽略: orderId={}", command.getOrderId());
            return;  // 未化债的退款不需要回滚
        }

        // 3. 计算回滚金额
        Money rollbackAmount = calculateRollbackAmount(
            command.getOrderId(),
            command.getOrderDetailId(),
            originalRecord,
            command.getRefundStatus()
        );

        // 4. 查询合同
        DebtContract contract = contractRepository.findById(originalRecord.getContractId());
        if (contract == null) {
            throw new BusinessException("合同不存在: contractId=" + originalRecord.getContractId());
        }

        // 5. 执行回滚 (领域行为)
        contract.rollback(
            rollbackAmount,
            OrderId.of(command.getOrderId()),
            command.getOrderDetailId(),
            command.getOrderCreateTime(),
            command.getDescription(),
            RefundStatus.fromCode(command.getRefundStatus())
        );

        // 6. 持久化
        contractRepository.save(contract);

        // 7. 发布领域事件
        publishDomainEvents(contract);

        log.info("[化债回滚] 完成: contractId={}, amount={}", contract.getId(), rollbackAmount);
    }

    // ============ 私有方法 ============

    private boolean isAlreadySettled(String orderId, Integer refundStatus) {
        // 查询是否存在相同 orderId + refundStatus 的记录
        return contractRepository.existsRepaymentRecord(orderId, refundStatus);
    }

    private boolean isAlreadyRolledBack(String orderId, Integer refundStatus) {
        return contractRepository.existsRepaymentRecord(orderId, refundStatus);
    }

    private boolean isValidOrderStatus(Integer orderStatus, Integer refundStatus) {
        // 只处理: 订单状态=5(已收货)或6(已完成)，退款状态=0/2/3
        boolean validOrderStatus = orderStatus != null && (orderStatus == 5 || orderStatus == 6);
        boolean validRefundStatus = refundStatus != null &&
            (refundStatus == 0 || refundStatus == 2 || refundStatus == 3);
        return validOrderStatus && validRefundStatus;
    }

    private Money queryDivideAmount(String orderId, Long orderDetailId) {
        DivideRecord divideRecord = divideRecordRepository.findByOrderId(orderId);
        if (divideRecord == null || !divideRecord.isDivided()) {
            return null;
        }

        if (orderDetailId != null) {
            // 商品级: 精确查询
            return divideRecord.getDebtorAmountByOrderDetailId(orderDetailId);
        } else {
            // 订单级: 查询债务人总金额
            return divideRecord.getDebtorTotalAmount();
        }
    }

    private Money calculateRollbackAmount(String orderId, Long orderDetailId,
                                          RepaymentRecordInfo originalRecord,
                                          Integer refundStatus) {
        if (refundStatus == 3) {
            // 全额退款: 回滚全部已化债金额
            return originalRecord.getAmount();
        }

        // 部分退款
        if (orderDetailId != null) {
            // 商品级: 查询该商品的分账金额
            DivideRecord divideRecord = divideRecordRepository.findByOrderId(orderId);
            return divideRecord.getDebtorAmountByOrderDetailId(orderDetailId);
        } else {
            // 订单级: 无法精确计算，使用原记录金额(或按比例，需要业务确认)
            // 这里暂时使用原记录金额
            return originalRecord.getAmount();
        }
    }

    private RepaymentRecordInfo findOriginalSettleRecord(String orderId) {
        // 查询type=0(收入)的原始化债记录
        return contractRepository.findRepaymentRecordByOrderIdAndType(orderId, RecordType.INCOME);
    }

    private void publishDomainEvents(DebtContract contract) {
        List<DomainEvent> events = contract.getDomainEvents();
        for (DomainEvent event : events) {
            eventPublisher.publish(event);
        }
        contract.clearDomainEvents();
    }
}
```

### 3.2 PreDivideAppService - 预分账应用服务

```java
/**
 * 预分账应用服务
 */
@Service
@Slf4j
@RequiredArgsConstructor
public class PreDivideAppService {

    private final DivideRecordRepository divideRecordRepository;
    private final MerchantQueryService merchantQueryService;  // 防腐层: 查询商户信息
    private final YeepayDivideService yeepayDivideService;    // 防腐层: 易宝分账
    private final DomainEventPublisher eventPublisher;

    /**
     * 创建预分账并执行分账
     */
    @Transactional(rollbackFor = Exception.class)
    public void createAndExecuteDivide(CreatePreDivideCommand command) {
        log.info("[预分账] 收到命令: orderId={}", command.getOrderId());

        // 1. 幂等检查
        DivideRecord existRecord = divideRecordRepository.findByOrderId(command.getOrderId());
        if (existRecord != null) {
            log.info("[预分账] 订单已存在分账记录: orderId={}, status={}",
                command.getOrderId(), existRecord.getStatus());
            return;
        }

        // 2. 构建分账记录聚合
        DivideRecord divideRecord = buildDivideRecord(command);

        // 3. 保存预分账记录 (status=PENDING)
        divideRecordRepository.save(divideRecord);

        // 4. 调用易宝执行分账 (防腐层)
        try {
            YeepayDivideResult result = yeepayDivideService.executeDivide(
                buildYeepayRequest(divideRecord)
            );

            // 5. 更新分账状态
            if (result.isSuccess()) {
                divideRecord.markCompleted(result.getBatchNo());
                log.info("[预分账] 分账成功: orderId={}, batchNo={}",
                    command.getOrderId(), result.getBatchNo());
            } else {
                divideRecord.markFailed();
                log.error("[预分账] 分账失败: orderId={}, reason={}",
                    command.getOrderId(), result.getErrorMsg());
            }

            divideRecordRepository.save(divideRecord);

        } catch (Exception e) {
            log.error("[预分账] 调用易宝异常: orderId={}", command.getOrderId(), e);
            divideRecord.markFailed();
            divideRecordRepository.save(divideRecord);
            throw new BusinessException("分账执行失败: " + e.getMessage());
        }
    }

    private DivideRecord buildDivideRecord(CreatePreDivideCommand command) {
        List<DivideItem> items = new ArrayList<>();

        for (CreatePreDivideCommand.DivideItemDTO dto : command.getDivideItems()) {
            // 查询商户信息获取子商户号
            String subMerNo = merchantQueryService.getSubMerNo(
                dto.getLedgerId(),
                MerType.fromCode(dto.getMerType())
            );

            DivideItem item = DivideItem.builder()
                .orderDetailId(dto.getOrderDetailId())
                .productName(dto.getProductName())
                .ledgerId(dto.getLedgerId())
                .merType(MerType.fromCode(dto.getMerType()))
                .subMerNo(subMerNo)
                .amount(Money.of(dto.getAmount()))
                .build();

            items.add(item);
        }

        return DivideRecord.builder()
            .orderId(OrderId.of(command.getOrderId()))
            .orderAmount(Money.of(command.getOrderAmount()))
            .status(DivideStatus.PENDING)
            .items(items)
            .build();
    }

    private YeepayDivideRequest buildYeepayRequest(DivideRecord record) {
        // 按商户类型合并金额，构建易宝请求
        // ... 具体实现
        return null;
    }
}
```

### 3.3 DivideAmountQueryAppService - 分账金额查询服务

```java
/**
 * 分账金额查询应用服务
 *
 * 提供给化债服务跨聚合查询
 */
@Service
@RequiredArgsConstructor
public class DivideAmountQueryAppService {

    private final DivideRecordRepository divideRecordRepository;

    /**
     * 查询订单的债务人分账金额
     */
    public DivideAmountDTO getDivideAmountByOrder(String orderId, Integer merType) {
        DivideRecord record = divideRecordRepository.findByOrderId(orderId);

        if (record == null) {
            return null;
        }

        DivideAmountDTO dto = new DivideAmountDTO();
        dto.setOrderId(orderId);
        dto.setHasActualDivide(record.isDivided());

        if (record.isDivided() && merType == MerType.DEBTOR.getCode()) {
            dto.setActualDivideAmount(record.getDebtorTotalAmount().getAmount());
        }

        return dto;
    }
}

@Data
public class DivideAmountDTO {
    private String orderId;
    private Boolean hasActualDivide;
    private BigDecimal actualDivideAmount;
}
```

---

## 4. 防腐层 (Anti-Corruption Layer)

### 4.1 防腐层接口定义

```java
/**
 * 会员查询服务 (防腐层)
 *
 * 隔离会员系统的查询
 */
public interface MemberQueryService {

    /**
     * 通过unionId查询会员用户ID
     */
    Long getMemberUserIdByUnionId(String unionId);
}

/**
 * 委案查询服务 (防腐层)
 */
public interface CaseEntrustQueryService {

    /**
     * 通过订单号查询委案信息
     */
    CaseEntrustInfo findByOrderId(String orderId);
}

/**
 * 委案信息 (防腐层DTO)
 */
@Data
public class CaseEntrustInfo {
    private Long id;
    private Long memberUserId;
    private String status;
}

/**
 * 商户查询服务 (防腐层)
 */
public interface MerchantQueryService {

    /**
     * 获取易宝子商户号
     *
     * @param ledgerId 分账标识(供应商为mer_id，债务人为unionId)
     * @param merType 商户类型
     * @return 易宝子商户号
     */
    String getSubMerNo(String ledgerId, MerType merType);
}

/**
 * 易宝分账服务 (防腐层)
 */
public interface YeepayDivideService {

    /**
     * 执行分账
     */
    YeepayDivideResult executeDivide(YeepayDivideRequest request);

    /**
     * 完成分账
     */
    YeepayDivideResult completeDivide(String batchNo);
}
```

### 4.2 防腐层架构图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           应用层                                         │
│  ┌─────────────────────┐  ┌─────────────────────┐                       │
│  │ DebtSettlementApp   │  │ PreDivideAppService │                       │
│  │ Service             │  │                     │                       │
│  └──────────┬──────────┘  └──────────┬──────────┘                       │
│             │                        │                                   │
└─────────────┼────────────────────────┼───────────────────────────────────┘
              │                        │
              ▼                        ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                           防腐层 (ACL)                                   │
│  ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐            │
│  │ MemberQuery     │ │ CaseEntrust     │ │ MerchantQuery   │            │
│  │ Service         │ │ QueryService    │ │ Service         │            │
│  └────────┬────────┘ └────────┬────────┘ └────────┬────────┘            │
│           │                   │                   │                      │
│  ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐            │
│  │ YeepayDivide    │ │                 │ │                 │            │
│  │ Service         │ │                 │ │                 │            │
│  └────────┬────────┘ └────────┬────────┘ └────────┬────────┘            │
└───────────┼───────────────────┼───────────────────┼──────────────────────┘
            │                   │                   │
            ▼                   ▼                   ▼
┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐
│  会员系统        │ │  委案系统        │ │  商户系统        │
│  (现有Mapper)    │ │  (现有Mapper)    │ │  (现有Mapper)    │
└─────────────────┘ └─────────────────┘ └─────────────────┘
            │
            ▼
┌─────────────────┐
│  易宝支付        │
│  (HTTP API)     │
└─────────────────┘
```

---

## 5. 接口层 (Interface Layer)

### 5.1 Controller

```java
/**
 * 化债接口控制器
 *
 * 接收商城回调
 */
@Tag(name = "化债接口")
@RestController
@RequestMapping("/crm/debt")
@RequiredArgsConstructor
@Slf4j
public class DebtSettlementController {

    private final DebtSettlementAppService debtSettlementAppService;

    /**
     * 处理订单化债 (商城确认收货/退款回调)
     *
     * 对应原 /crm/order/processOrder
     */
    @PostMapping("/process")
    @Operation(summary = "处理订单化债")
    @PermitAll
    public CommonResult<Boolean> processOrder(@RequestBody @Validated OrderProcessRequest request) {
        try {
            log.info("[化债接口] 收到请求: {}", request);

            // 根据type区分化债还是回滚
            if (request.getType() == 0) {
                // 化债
                SettleDebtCommand command = convertToSettleCommand(request);
                debtSettlementAppService.settleDebt(command);
            } else {
                // 退款回滚
                RollbackDebtCommand command = convertToRollbackCommand(request);
                debtSettlementAppService.rollbackDebt(command);
            }

            return CommonResult.success(true);

        } catch (BusinessException e) {
            log.warn("[化债接口] 业务异常: {}", e.getMessage());
            return CommonResult.error(400, e.getMessage());
        } catch (Exception e) {
            log.error("[化债接口] 系统异常", e);
            return CommonResult.error(500, "系统异常: " + e.getMessage());
        }
    }

    private SettleDebtCommand convertToSettleCommand(OrderProcessRequest request) {
        return SettleDebtCommand.builder()
            .orderId(request.getPlatOrderNo())
            .orderDetailId(request.getOrderDetailId())
            .memberUserId(request.getMemberUserId())
            .unionId(request.getUnionId())
            .orderStatus(request.getOrderStatus())
            .refundStatus(request.getRefundStatus())
            .orderCreateTime(request.getCreateTime())
            .description(request.getDescription())
            .build();
    }

    private RollbackDebtCommand convertToRollbackCommand(OrderProcessRequest request) {
        return RollbackDebtCommand.builder()
            .orderId(request.getPlatOrderNo())
            .orderDetailId(request.getOrderDetailId())
            .memberUserId(request.getMemberUserId())
            .unionId(request.getUnionId())
            .refundStatus(request.getRefundStatus())
            .orderCreateTime(request.getCreateTime())
            .description(request.getDescription())
            .build();
    }
}

/**
 * 订单处理请求 (兼容原接口)
 */
@Data
public class OrderProcessRequest {
    private String platOrderNo;      // 订单号
    private Long orderDetailId;      // 商品明细ID(新增)
    private Long memberUserId;
    private String unionId;
    private Integer orderStatus;
    private Integer refundStatus;
    private Integer type;            // 0化债 1退款
    private String createTime;
    private String description;
}
```

---

## 6. 四层架构目录结构

```
tx-module-debt/                          # 化债核心域模块
├── tx-module-debt-api/                  # API层(给其他模块调用)
│   └── src/main/java/.../debt/api/
│       ├── DivideAmountApi.java         # 分账金额查询API
│       └── dto/
│           └── DivideAmountRespDTO.java
│
├── tx-module-debt-biz/                  # 业务层
│   └── src/main/java/.../debt/
│       │
│       ├── domain/                      # 领域层 ★核心★
│       │   ├── model/                   # 领域模型
│       │   │   ├── aggregate/           # 聚合根
│       │   │   │   ├── DebtContract.java
│       │   │   │   └── DivideRecord.java
│       │   │   ├── entity/              # 实体
│       │   │   │   ├── RepaymentPlan.java
│       │   │   │   ├── RepaymentRecord.java
│       │   │   │   └── DivideItem.java
│       │   │   └── valueobject/         # 值对象
│       │   │       ├── Money.java
│       │   │       ├── OrderId.java
│       │   │       └── Period.java
│       │   ├── event/                   # 领域事件
│       │   │   ├── DebtSettledEvent.java
│       │   │   ├── DebtRolledBackEvent.java
│       │   │   └── ContractCompletedEvent.java
│       │   ├── service/                 # 领域服务
│       │   │   └── DebtSettlementDomainService.java
│       │   └── repository/              # 仓储接口
│       │       ├── DebtContractRepository.java
│       │       └── DivideRecordRepository.java
│       │
│       ├── application/                 # 应用层
│       │   ├── service/                 # 应用服务
│       │   │   ├── DebtSettlementAppService.java
│       │   │   ├── PreDivideAppService.java
│       │   │   └── DivideAmountQueryAppService.java
│       │   ├── command/                 # 命令
│       │   │   ├── SettleDebtCommand.java
│       │   │   ├── RollbackDebtCommand.java
│       │   │   └── CreatePreDivideCommand.java
│       │   ├── query/                   # 查询
│       │   │   └── ContractProgressQuery.java
│       │   └── dto/                     # 数据传输对象
│       │       └── ContractProgressDTO.java
│       │
│       ├── infrastructure/              # 基础设施层
│       │   ├── repository/              # 仓储实现
│       │   │   ├── DebtContractRepositoryImpl.java
│       │   │   └── DivideRecordRepositoryImpl.java
│       │   ├── persistence/             # 持久化
│       │   │   ├── mapper/              # MyBatis Mapper
│       │   │   │   ├── DebtContractMapper.java
│       │   │   │   └── DivideRecordMapper.java
│       │   │   ├── dataobject/          # DO对象
│       │   │   │   ├── DebtContractDO.java
│       │   │   │   └── DivideRecordDO.java
│       │   │   └── converter/           # DO与领域对象转换
│       │   │       └── DebtContractConverter.java
│       │   ├── acl/                     # 防腐层实现
│       │   │   ├── MemberQueryServiceImpl.java
│       │   │   ├── CaseEntrustQueryServiceImpl.java
│       │   │   ├── MerchantQueryServiceImpl.java
│       │   │   └── YeepayDivideServiceImpl.java
│       │   └── event/                   # 事件发布
│       │       └── SpringDomainEventPublisher.java
│       │
│       └── interfaces/                  # 接口层
│           ├── controller/              # Controller
│           │   ├── DebtSettlementController.java
│           │   └── PreDivideController.java
│           └── vo/                      # 视图对象
│               ├── OrderProcessRequest.java
│               └── PreDivideRequest.java
│
└── pom.xml
```

---

## 7. 新旧代码对比

| 原代码位置 | 新代码位置 | 说明 |
|-----------|-----------|------|
| OrderServiceImpl.processOrder() | DebtSettlementAppService.settleDebt() | 应用服务编排 |
| 幂等检查逻辑 | DebtSettlementAppService.isAlreadySettled() | 提取为独立方法 |
| 金额计算逻辑 | DebtContract.settle() | 下沉到领域层 |
| 合同金额更新 | DebtContract.settle() | 领域行为 |
| 还款计划更新 | DebtContract.updateRepaymentPlanForSettle() | 聚合内部方法 |
| 明细插入 | DebtContractRepository.save() | 仓储统一持久化 |
| UserMappingService | MemberQueryService (ACL) | 防腐层隔离 |
| CaseEntrustMapper | CaseEntrustQueryService (ACL) | 防腐层隔离 |
| DivideAmountApi | DivideAmountQueryAppService | 跨聚合查询 |

---

## 8. 下一步

- [ ] 基础设施层实现 (Repository、Mapper、Converter)
- [ ] 防腐层具体实现
- [ ] 单元测试编写
