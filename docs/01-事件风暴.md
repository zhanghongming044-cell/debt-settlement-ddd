# 化债核心域 - 事件风暴文档

> 版本: v1.0
> 日期: 2025-11-27
> 作者: [张洪铭]

---

## 1. 项目背景

### 1.1 业务场景

债务化解平台，帮助债务人通过消费行为逐步化解债务。

**核心流程**：
1. 债务人在商城下单购买商品
2. 支付成功后，平台通过易宝支付进行分账（供应商、债务人）
3. 用户确认收货后，债务人分账金额用于化解债务
4. 支持退款场景下的化债回滚

### 1.2 系统现状问题

| 问题 | 描述 | 影响 |
|------|------|------|
| 时序耦合 | 分账T+0，结算T+1，确认收货T+7 | 钱到账但债务未化解 |
| 分布式一致性 | 分账在pay模块，化债在crm模块 | 数据可能不一致 |
| 无补偿机制 | 分账成功但化债失败无法恢复 | 资金与债务不匹配 |
| 无对账系统 | 分账记录与化债记录无校验 | 问题难以发现 |
| 部分退款困难 | 订单级分账，无法精确回滚 | 退款金额计算混乱 |

---

## 2. 事件风暴结果

### 2.1 核心领域事件

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           领 域 事 件 清 单                              │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  分账相关:                                                              │
│  ├── 🟧 PreDivideCreated        预分账已创建                            │
│  ├── 🟧 DivideCompleted         分账已完成                              │
│  └── 🟧 DivideFailed            分账已失败                              │
│                                                                         │
│  化债相关:                                                              │
│  ├── 🟧 DebtSettled             化债已执行                              │
│  ├── 🟧 DebtRolledBack          化债已回滚(全额)                        │
│  ├── 🟧 DebtPartiallyRolledBack 化债已部分回滚                          │
│  └── 🟧 ContractCompleted       合同已完成(债务清零)                    │
│                                                                         │
│  退款相关:                                                              │
│  ├── 🟧 RefundRequested         退款已申请                              │
│  ├── 🟧 RefundApproved          退款已审核通过                          │
│  └── 🟧 RefundIgnored           退款已忽略(未化债状态)                  │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 2.2 命令清单

| 命令 | 触发来源 | 产生事件 |
|------|----------|----------|
| CreatePreDivide | 商城支付回调 | PreDivideCreated |
| ExecuteDivide | 系统(同步) | DivideCompleted / DivideFailed |
| SettleDebt | 商城确认收货回调 | DebtSettled |
| RollbackDebt | 商城退款回调 | DebtRolledBack / DebtPartiallyRolledBack |
| IgnoreRefund | 商城退款回调(未化债) | RefundIgnored |

### 2.3 主流程时序图

```
商城系统          支付网关(易宝)        分账服务           化债服务
   │                   │                  │                  │
   │  支付成功回调      │                  │                  │
   │──────────────────────────────────────▶│                  │
   │                   │                  │                  │
   │                   │   创建预分账      │                  │
   │                   │◀─────────────────│                  │
   │                   │                  │                  │
   │                   │   执行分账请求    │                  │
   │                   │◀─────────────────│                  │
   │                   │                  │                  │
   │                   │   分账结果返回    │                  │
   │                   │─────────────────▶│                  │
   │                   │                  │                  │
   │                   │                  │  (状态: 已分账)   │
   │                   │                  │                  │
   │  ═══════════════ 等待用户确认收货 ═══════════════════   │
   │                   │                  │                  │
   │  确认收货回调      │                  │                  │
   │──────────────────────────────────────────────────────▶│
   │                   │                  │                  │
   │                   │                  │   查询分账金额    │
   │                   │                  │◀─────────────────│
   │                   │                  │                  │
   │                   │                  │   返回债务人金额  │
   │                   │                  │─────────────────▶│
   │                   │                  │                  │
   │                   │                  │   执行化债       │
   │                   │                  │                  │
   │  化债成功响应      │                  │                  │
   │◀──────────────────────────────────────────────────────│
   │                   │                  │                  │
```

### 2.4 退款流程时序图 (修正版)

**重要**: 退款分两步调用，保证一致性

```
商城系统              易宝支付           分账服务           化债服务
   │                     │                  │                  │
   │  用户申请退款        │                  │                  │
   │  商城审核通过        │                  │                  │
   │                     │                  │                  │
   ╔══════════════════════════════════════════════════════════════════════╗
   ║  步骤1: 分账退还 (商城调用管家退款接口)                                ║
   ╚══════════════════════════════════════════════════════════════════════╝
   │                     │                  │                  │
   │  调用退款接口(含分账退还参数)          │                  │
   │────────────────────────────────────────▶│                  │
   │                     │                  │                  │
   │                     │   分账退还请求    │                  │
   │                     │◀─────────────────│                  │
   │                     │                  │                  │
   │                     │   退还结果        │                  │
   │                     │─────────────────▶│                  │
   │                     │                  │                  │
   │  分账退还结果返回    │                  │                  │
   │◀───────────────────────────────────────│                  │
   │                     │                  │                  │
   │  ┌─────────────────────────────────────────────────────┐  │
   │  │ 如果分账退还失败，流程终止，不调用化债接口            │  │
   │  │ → 保证一致性：钱没退，债务也不恢复                   │  │
   │  └─────────────────────────────────────────────────────┘  │
   │                     │                  │                  │
   ╔══════════════════════════════════════════════════════════════════════╗
   ║  步骤2: 化债回滚 (商城调用管家化债接口)                                ║
   ╚══════════════════════════════════════════════════════════════════════╝
   │                     │                  │                  │
   │  调用化债接口(type=1, refundStatus=2或3)                 │
   │─────────────────────────────────────────────────────────▶│
   │                     │                  │                  │
   │                     │                  │   检查化债状态    │
   │                     │                  │                  │
   ├──────────────────── 场景A: 未化债 ────────────────────────┤
   │                     │                  │                  │
   │                     │                  │   忽略,无需处理   │
   │  返回成功           │                  │                  │
   │◀─────────────────────────────────────────────────────────│
   │                     │                  │                  │
   ├──────────────────── 场景B: 已化债 ────────────────────────┤
   │                     │                  │                  │
   │                     │                  │   查询分账金额    │
   │                     │                  │◀────────────────│
   │                     │                  │                  │
   │                     │                  │   执行化债回滚    │
   │                     │                  │   (合同+还款计划) │
   │                     │                  │                  │
   │  回滚成功响应       │                  │                  │
   │◀─────────────────────────────────────────────────────────│
   │                     │                  │                  │
```

**一致性保证策略**:

- 分账退还失败 → 商城不调用化债接口 → 化债不回滚 ✅
- 分账退还成功 → 商城调用化债接口 → 化债必须成功
- 化债回滚失败 → 商城将请求放入Redis队列，定时任务重试 ✅

> **现有机制**: 商城端已实现重试机制。管家返回false时，商城将请求放入Redis队列，定时任务会重新调用管家化债接口，保证最终一致性。

---

## 3. 聚合识别

### 3.1 聚合根清单

| 聚合根 | 所属上下文 | 职责 |
|--------|------------|------|
| DivideRecord | 分账上下文 | 管理分账生命周期（含分账退还） |
| DebtContract | 化债上下文 | 管理债务、还款计划、化债明细（含回滚） |

> **设计决策**: 不需要单独的 RefundRecord 聚合根。退款回滚作为 `RepaymentRecord(type=EXPENSE)` 记录在 DebtContract 聚合内，简化模型。

### 3.2 聚合结构图

```
┌─────────────────────────────────────────────────────────────────────┐
│                     DivideRecord 聚合                               │
├─────────────────────────────────────────────────────────────────────┤
│  DivideRecord (聚合根)                                              │
│  ├── id: Long                      主键                            │
│  ├── orderId: String               商城订单号                       │
│  ├── orderAmount: Money            订单总金额                       │
│  ├── yeepayBatchNo: String         易宝批次号                       │
│  ├── status: DivideStatus          状态(PENDING/COMPLETED/FAILED)  │
│  │                                                                  │
│  └── items: List<DivideItem>       分账明细(实体)                   │
│        ├── orderDetailId: Long     商品明细ID(可空,兼容订单级)      │
│        ├── productName: String     商品名称                        │
│        ├── ledgerId: String        分账标识                        │
│        ├── merType: MerType        商户类型(SUPPLIER/DEBTOR)       │
│        ├── subMerNo: String        易宝子商户号                    │
│        └── amount: Money           分账金额                        │
└─────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────┐
│                     DebtContract 聚合                               │
├─────────────────────────────────────────────────────────────────────┤
│  DebtContract (聚合根)                                              │
│  ├── id: Long                      主键                            │
│  ├── caseEntrustId: Long           委案ID(跨聚合引用)              │
│  ├── memberUserId: Long            会员用户ID                      │
│  ├── totalDebtAmount: Money        总债务金额                      │
│  ├── settledAmount: Money          已化债金额                      │
│  ├── remainingAmount: Money        剩余债务金额                    │
│  ├── status: ContractStatus        状态                            │
│  │                                                                  │
│  ├── repaymentPlans: List<RepaymentPlan>  还款计划(实体)           │
│  │     ├── id: Long                                                │
│  │     ├── period: YearMonth       期数(年月)                      │
│  │     ├── planAmount: Money       计划金额                        │
│  │     └── actualAmount: Money     实际金额                        │
│  │                                                                  │
│  └── repaymentRecords: List<RepaymentRecord>  化债明细(实体)       │
│        ├── id: Long                                                │
│        ├── orderId: String         关联订单号                      │
│        ├── orderDetailId: Long     关联商品明细ID(可空)            │
│        ├── amount: Money           化债金额                        │
│        ├── type: RecordType        类型(INCOME/EXPENSE)            │
│        └── refundStatus: RefundStatus  退款状态                    │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 4. 上下文映射

### 4.1 限界上下文图

```
                    ┌─────────────────────────────────┐
                    │           商城系统               │
                    │        (外部系统)                │
                    └───────────────┬─────────────────┘
                                    │
                          ┌─────────▼─────────┐
                          │    防腐层 (ACL)    │
                          └─────────┬─────────┘
                                    │
                ┌───────────────────┴───────────────────┐
                │                                       │
                ▼                                       ▼
        ┌───────────────┐                       ┌───────────────┐
        │   分账上下文   │                       │   化债上下文   │
        │   (Divide)    │──────────────────────▶│   (Settle)    │
        │               │      提供分账金额      │               │
        └───────┬───────┘                       └───────────────┘
                │
                │ 防腐层
                ▼
        ┌───────────────┐
        │   易宝支付     │
        │  (外部系统)    │
        └───────────────┘

关系说明:
- 分账上下文: 管理预分账、实际分账、分账退还
- 化债上下文: 管理化债执行、化债回滚（退款触发）
- 分账上下文 → 化债上下文: 提供分账金额查询（跨聚合）
```

### 4.2 上下文关系

| 上游 | 下游 | 关系类型 | 说明 |
|------|------|----------|------|
| 商城系统 | 分账上下文 | 防腐层 | 接收支付回调、退款回调（分账退还） |
| 商城系统 | 化债上下文 | 防腐层 | 接收确认收货回调、化债回滚回调 |
| 分账上下文 | 化债上下文 | 客户-供应商 | 提供分账金额查询 |
| 分账上下文 | 易宝支付 | 防腐层 | 调用易宝分账/分账退还API |

---

## 5. 状态机设计

### 5.1 化债状态机

```
                    ┌─────────────┐
                    │   待分账    │
                    │  PENDING    │
                    └──────┬──────┘
                           │ DivideCompleted
                           ▼
                    ┌─────────────┐
    RefundApproved  │   已分账    │
    (未化债时忽略)  │  DIVIDED    │
                    └──────┬──────┘
                           │ DebtSettled (确认收货)
                           ▼
          ┌────────────────┼────────────────┐
          │                │                │
          │ RefundApproved │                │ 债务清零
          │ (全额退款)     │ RefundApproved │
          ▼                │ (部分退款)     ▼
   ┌─────────────┐         ▼         ┌─────────────┐
   │   已回滚    │  ┌─────────────┐  │   已完成    │
   │ ROLLED_BACK │  │  部分回滚   │  │  COMPLETED  │
   └─────────────┘  │PARTIAL_BACK │  └─────────────┘
                    └─────────────┘
```

---

## 6. 设计决策记录

### 6.1 部分退款回滚规则

**决策**: 商品级精确回滚，兼容订单级按比例回滚

**原因**:
- 业务需要精确到商品级别的退款回滚
- 但需要兼容现有订单级分账的历史数据

**实现方式**:
```java
if (orderDetailId != null) {
    // 商品级: 精确查询该商品的分账金额进行回滚
    rollbackAmount = divideService.getAmountByOrderDetailId(orderId, orderDetailId);
} else {
    // 订单级: 按退款金额占订单金额比例计算
    rollbackAmount = settledAmount * (refundAmount / orderAmount);
}
```

### 6.2 分账记录粒度

**决策**: 支持商品明细级别，orderDetailId可为空

**接口改造**:
```json
{
  "orderId": "xxx",
  "divideInfo": [
    {
      "orderDetailId": "10001",  // 新增,可空
      "productName": "商品A",    // 新增,可空
      "ledgerId": "xxx",
      "amount": "30.00",
      "merType": 1
    }
  ]
}
```

### 6.3 平台分账处理

**决策**: 不单独记录，剩余金额自动归平台

**原因**: 平台分账金额 = 订单金额 - 供应商分账 - 债务人分账，无需显式记录

---

## 7. 下一步工作

- [ ] Day 2-3: 领域模型详细设计
- [ ] Day 4: 值对象和实体定义
- [ ] Day 5: 领域服务识别

---

## 附录: 术语表

| 术语 | 英文 | 含义 |
|------|------|------|
| 预分账 | Pre-Divide | 支付成功后记录待分账信息 |
| 实际分账 | Actual Divide | 调用易宝完成的分账 |
| 化债 | Debt Settlement | 将分账金额用于减少债务 |
| 委案 | Case Entrust | 债务人委托平台处理的债务案件 |
| 还款计划 | Repayment Plan | 按月份的债务偿还计划 |
