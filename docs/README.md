# å€ºåŠ¡åŒ–è§£å¹³å° - DDD æ¶æ„å®è·µ

> åŸºäºé¢†åŸŸé©±åŠ¨è®¾è®¡ï¼ˆDDDï¼‰çš„å€ºåŠ¡åŒ–è§£æ ¸å¿ƒåŸŸå®ç°ï¼ŒåŒ…å«å®Œæ•´çš„æˆ˜ç•¥è®¾è®¡æ–‡æ¡£å’Œæˆ˜æœ¯ä»£ç å®ç°ã€‚

## ğŸ“– é¡¹ç›®èƒŒæ™¯

### ä¸šåŠ¡åœºæ™¯

å€ºåŠ¡åŒ–è§£å¹³å°å¸®åŠ©å€ºåŠ¡äººé€šè¿‡æ¶ˆè´¹è¡Œä¸ºé€æ­¥åŒ–è§£å€ºåŠ¡ï¼š

1. å€ºåŠ¡äººåœ¨å•†åŸä¸‹å•è´­ä¹°å•†å“
2. æ”¯ä»˜æˆåŠŸåï¼Œå¹³å°é€šè¿‡æ”¯ä»˜ç½‘å…³è¿›è¡Œåˆ†è´¦ï¼ˆä¾›åº”å•†ã€å€ºåŠ¡äººï¼‰
3. ç”¨æˆ·ç¡®è®¤æ”¶è´§åï¼Œå€ºåŠ¡äººåˆ†è´¦é‡‘é¢ç”¨äºåŒ–è§£å€ºåŠ¡
4. æ”¯æŒé€€æ¬¾åœºæ™¯ä¸‹çš„åŒ–å€ºå›æ»š

### åŸç³»ç»Ÿç—›ç‚¹

| é—®é¢˜ | æè¿° | å½±å“ |
|------|------|------|
| æ—¶åºè€¦åˆ | åˆ†è´¦T+0ï¼Œç»“ç®—T+1ï¼Œç¡®è®¤æ”¶è´§T+7 | é’±åˆ°è´¦ä½†å€ºåŠ¡æœªåŒ–è§£ |
| åˆ†å¸ƒå¼ä¸€è‡´æ€§ | åˆ†è´¦åœ¨payæ¨¡å—ï¼ŒåŒ–å€ºåœ¨crmæ¨¡å— | æ•°æ®å¯èƒ½ä¸ä¸€è‡´ |
| æ— è¡¥å¿æœºåˆ¶ | åˆ†è´¦æˆåŠŸä½†åŒ–å€ºå¤±è´¥æ— æ³•æ¢å¤ | èµ„é‡‘ä¸å€ºåŠ¡ä¸åŒ¹é… |
| éƒ¨åˆ†é€€æ¬¾å›°éš¾ | è®¢å•çº§åˆ†è´¦ï¼Œæ— æ³•ç²¾ç¡®å›æ»š | é€€æ¬¾é‡‘é¢è®¡ç®—æ··ä¹± |

### è§£å†³æ–¹æ¡ˆ

è¿ç”¨ DDD æ–¹æ³•è®ºé‡æ–°è®¾è®¡åŒ–å€ºæ ¸å¿ƒåŸŸï¼Œå®ç°ï¼š

- âœ… æ¸…æ™°çš„é™ç•Œä¸Šä¸‹æ–‡åˆ’åˆ†ï¼ˆåˆ†è´¦ä¸Šä¸‹æ–‡ã€åŒ–å€ºä¸Šä¸‹æ–‡ï¼‰
- âœ… å……è¡€æ¨¡å‹ï¼Œä¸šåŠ¡é€»è¾‘å†…èšåœ¨èšåˆæ ¹
- âœ… æ”¯æŒå•†å“çº§ç²¾ç¡®åˆ†è´¦å’Œé€€æ¬¾å›æ»š
- âœ… é¢†åŸŸäº‹ä»¶é©±åŠ¨ï¼Œä¿è¯æœ€ç»ˆä¸€è‡´æ€§
- âœ… é˜²è…å±‚éš”ç¦»å¤–éƒ¨ç³»ç»Ÿ

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### é™ç•Œä¸Šä¸‹æ–‡

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚           å•†åŸç³»ç»Ÿ               â”‚
                    â”‚        (å¤–éƒ¨ç³»ç»Ÿ)                â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚    é˜²è…å±‚ (ACL)    â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                                       â”‚
                â–¼                                       â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   åˆ†è´¦ä¸Šä¸‹æ–‡   â”‚                       â”‚   åŒ–å€ºä¸Šä¸‹æ–‡   â”‚
        â”‚   (Divide)    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚   (Settle)    â”‚
        â”‚               â”‚      æä¾›åˆ†è´¦é‡‘é¢      â”‚               â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â”‚ é˜²è…å±‚
                â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   æ”¯ä»˜ç½‘å…³     â”‚
        â”‚  (å¤–éƒ¨ç³»ç»Ÿ)    â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å››å±‚æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           interfacesï¼ˆæ¥å£å±‚ï¼‰                           â”‚
â”‚  DebtSettlementController.java   - REST API                            â”‚
â”‚  SettleDebtRequest.java          - è¯·æ±‚ DTO                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          applicationï¼ˆåº”ç”¨å±‚ï¼‰                           â”‚
â”‚  DebtSettlementAppService.java   - åº”ç”¨æœåŠ¡ï¼ˆç¼–æ’ã€äº‹åŠ¡ï¼‰                â”‚
â”‚  SettleDebtCommand.java          - å‘½ä»¤å¯¹è±¡                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            domainï¼ˆé¢†åŸŸå±‚ï¼‰â˜…æ ¸å¿ƒâ˜…                        â”‚
â”‚  model/                                                                 â”‚
â”‚    â”œâ”€â”€ shared/       Money, OrderId, Period    - å€¼å¯¹è±¡                 â”‚
â”‚    â”œâ”€â”€ settle/       DebtContract, RepaymentPlan, RepaymentRecord      â”‚
â”‚    â””â”€â”€ divide/       DivideRecord              - èšåˆæ ¹                 â”‚
â”‚  event/              DebtSettledEvent...       - é¢†åŸŸäº‹ä»¶               â”‚
â”‚  repository/         DebtContractRepository    - ä»“å‚¨æ¥å£               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        infrastructureï¼ˆåŸºç¡€è®¾æ–½å±‚ï¼‰                      â”‚
â”‚  persistence/        Mapper, DO, Converter     - æŒä¹…åŒ–å®ç°             â”‚
â”‚  acl/                CaseEntrustQueryService   - é˜²è…å±‚                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### èšåˆè®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    DebtContract èšåˆï¼ˆåŒ–å€ºåˆåŒï¼‰                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  DebtContract (èšåˆæ ¹)                                          â”‚
â”‚  â”œâ”€â”€ id, caseEntrustId, memberUserId                           â”‚
â”‚  â”œâ”€â”€ totalAmount, paidTotalAmount                              â”‚
â”‚  â”œâ”€â”€ status: SettleStatus                                      â”‚
â”‚  â”‚                                                              â”‚
â”‚  â”œâ”€â”€ + settleDebt(orderId, amount, date) : boolean   // åŒ–å€º   â”‚
â”‚  â”œâ”€â”€ + rollbackDebt(orderId, amount) : Money         // å›æ»š   â”‚
â”‚  â””â”€â”€ + getAndClearDomainEvents() : List<DomainEvent>           â”‚
â”‚           â”‚                              â”‚                      â”‚
â”‚           â”‚ 1:N                          â”‚ 1:N                  â”‚
â”‚           â–¼                              â–¼                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ RepaymentPlan  â”‚            â”‚  RepaymentRecord   â”‚          â”‚
â”‚  â”‚ - period       â”‚            â”‚  - orderId         â”‚          â”‚
â”‚  â”‚ - dueAmount    â”‚            â”‚  - amount, type    â”‚          â”‚
â”‚  â”‚ - paidAmount   â”‚            â”‚  - period          â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    DivideRecord èšåˆï¼ˆåˆ†è´¦è®°å½•ï¼‰                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  DivideRecord (èšåˆæ ¹)                                          â”‚
â”‚  â”œâ”€â”€ orderId, merchantNo, merchantType                         â”‚
â”‚  â”œâ”€â”€ divideAmount, refundedAmount, status                      â”‚
â”‚  â”‚                                                              â”‚
â”‚  â”œâ”€â”€ + markAsDivided(requestNo)              // æ ‡è®°å·²åˆ†è´¦     â”‚
â”‚  â”œâ”€â”€ + refund(amount) : Money                // åˆ†è´¦é€€è¿˜       â”‚
â”‚  â””â”€â”€ + getEffectiveAmount() : Money          // æœ‰æ•ˆé‡‘é¢       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“ é¡¹ç›®ç»“æ„

```
debt-settlement-ddd/
â”œâ”€â”€ README.md                          # æœ¬æ–‡ä»¶
â”œâ”€â”€ docs/                              # è®¾è®¡æ–‡æ¡£
â”‚   â”œâ”€â”€ 01-äº‹ä»¶é£æš´.md                  # äº‹ä»¶é£æš´ã€é¢†åŸŸäº‹ä»¶è¯†åˆ«
â”‚   â”œâ”€â”€ 02-é¢†åŸŸæ¨¡å‹.md                  # èšåˆã€å®ä½“ã€å€¼å¯¹è±¡è®¾è®¡
â”‚   â”œâ”€â”€ 03-åº”ç”¨å±‚è®¾è®¡.md                # CQRSã€åº”ç”¨æœåŠ¡è®¾è®¡
â”‚   â””â”€â”€ 04-é˜²è…å±‚è®¾è®¡.md                # å¤–éƒ¨ç³»ç»Ÿéš”ç¦»ç­–ç•¥
â”‚
â””â”€â”€ src/                               # æºä»£ç 
    â””â”€â”€ main/java/.../settle/
        â”œâ”€â”€ domain/                    # é¢†åŸŸå±‚ â˜…æ ¸å¿ƒâ˜…
        â”‚   â”œâ”€â”€ model/
        â”‚   â”‚   â”œâ”€â”€ shared/            # å…±äº«å€¼å¯¹è±¡
        â”‚   â”‚   â”‚   â”œâ”€â”€ Money.java
        â”‚   â”‚   â”‚   â”œâ”€â”€ OrderId.java
        â”‚   â”‚   â”‚   â””â”€â”€ Period.java
        â”‚   â”‚   â”œâ”€â”€ settle/            # åŒ–å€ºèšåˆ
        â”‚   â”‚   â”‚   â”œâ”€â”€ DebtContract.java
        â”‚   â”‚   â”‚   â”œâ”€â”€ RepaymentPlan.java
        â”‚   â”‚   â”‚   â”œâ”€â”€ RepaymentRecord.java
        â”‚   â”‚   â”‚   â””â”€â”€ SettleStatus.java
        â”‚   â”‚   â””â”€â”€ divide/            # åˆ†è´¦èšåˆ
        â”‚   â”‚       â”œâ”€â”€ DivideRecord.java
        â”‚   â”‚       â””â”€â”€ DivideStatus.java
        â”‚   â”œâ”€â”€ event/                 # é¢†åŸŸäº‹ä»¶
        â”‚   â”‚   â”œâ”€â”€ DebtSettledEvent.java
        â”‚   â”‚   â”œâ”€â”€ DebtRolledBackEvent.java
        â”‚   â”‚   â””â”€â”€ ContractCompletedEvent.java
        â”‚   â””â”€â”€ repository/            # ä»“å‚¨æ¥å£
        â”‚       â”œâ”€â”€ DebtContractRepository.java
        â”‚       â””â”€â”€ DivideRecordRepository.java
        â”‚
        â”œâ”€â”€ application/               # åº”ç”¨å±‚
        â”‚   â”œâ”€â”€ command/               # å‘½ä»¤
        â”‚   â”‚   â”œâ”€â”€ SettleDebtCommand.java
        â”‚   â”‚   â””â”€â”€ RollbackDebtCommand.java
        â”‚   â””â”€â”€ service/               # åº”ç”¨æœåŠ¡
        â”‚       â””â”€â”€ DebtSettlementAppService.java
        â”‚
        â”œâ”€â”€ infrastructure/            # åŸºç¡€è®¾æ–½å±‚
        â”‚   â”œâ”€â”€ persistence/           # æŒä¹…åŒ–
        â”‚   â”‚   â”œâ”€â”€ mapper/
        â”‚   â”‚   â”œâ”€â”€ dataobject/
        â”‚   â”‚   â”œâ”€â”€ converter/
        â”‚   â”‚   â””â”€â”€ repository/
        â”‚   â””â”€â”€ acl/                   # é˜²è…å±‚
        â”‚       â”œâ”€â”€ CaseEntrustQueryService.java
        â”‚       â”œâ”€â”€ MemberQueryService.java
        â”‚       â””â”€â”€ YeepayDivideService.java
        â”‚
        â””â”€â”€ interfaces/                # æ¥å£å±‚
            â””â”€â”€ controller/
                â””â”€â”€ DebtSettlementController.java
```

## ğŸ’¡ æ ¸å¿ƒä»£ç ç¤ºä¾‹

### 1. å€¼å¯¹è±¡ - Moneyï¼ˆé‡‘é¢ï¼‰

```java
/**
 * é‡‘é¢å€¼å¯¹è±¡
 * ç‰¹ç‚¹ï¼šä¸å¯å˜ã€è‡ªå°è£…ã€å€¼ç›¸ç­‰
 */
public final class Money {
    private final long cents;  // ä½¿ç”¨åˆ†å­˜å‚¨ï¼Œé¿å…æµ®ç‚¹ç²¾åº¦é—®é¢˜

    public static final Money ZERO = new Money(0L);

    public static Money ofYuan(BigDecimal yuan) {
        long cents = yuan.multiply(BigDecimal.valueOf(100))
                .setScale(0, RoundingMode.HALF_UP)
                .longValue();
        return ofCents(cents);
    }

    public Money add(Money other) {
        return ofCents(this.cents + other.cents);
    }

    public Money subtract(Money other) {
        if (this.cents < other.cents) {
            throw new IllegalArgumentException("é‡‘é¢ä¸è¶³");
        }
        return ofCents(this.cents - other.cents);
    }
}
```

### 2. èšåˆæ ¹ - DebtContractï¼ˆåŒ–å€ºåˆåŒï¼‰

```java
/**
 * å€ºåŠ¡åˆåŒèšåˆæ ¹
 * èŒè´£ï¼šç®¡ç†è¿˜æ¬¾è®¡åˆ’ã€æ‰§è¡ŒåŒ–å€º/å›æ»šã€å‘å¸ƒé¢†åŸŸäº‹ä»¶
 */
public class DebtContract {

    private final List<RepaymentPlan> repaymentPlans;
    private final List<RepaymentRecord> repaymentRecords;
    private final List<DomainEvent> domainEvents;

    /**
     * æ‰§è¡ŒåŒ–å€ºï¼ˆæ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼‰
     */
    public boolean settleDebt(OrderId orderId, Money amount, LocalDate orderCreateTime) {
        // 1. æ ¹æ®è®¢å•æ—¶é—´åŒ¹é…æœŸæ•°
        Period period = Period.fromDate(orderCreateTime);
        Optional<RepaymentPlan> matchedPlan = findPlanByPeriod(period);

        if (matchedPlan.isEmpty()) {
            // æœŸæ•°ä¸åŒ¹é…ï¼Œå‘å¸ƒäº‹ä»¶ä½†ä¸æŠ¥é”™
            domainEvents.add(new RepaymentPlanNotMatchedEvent(this.id, orderId, period, amount));
            return false;
        }

        // 2. æ‰§è¡ŒåŒ–å€º
        RepaymentPlan plan = matchedPlan.get();
        Money actualPaid = plan.recordPayment(amount);

        // 3. æ›´æ–°åˆåŒå·²è¿˜æ€»é¢
        this.paidTotalAmount = this.paidTotalAmount.add(actualPaid);

        // 4. åˆ›å»ºè¿˜æ¬¾è®°å½•
        repaymentRecords.add(RepaymentRecord.createIncome(orderId, period, actualPaid));

        // 5. å‘å¸ƒé¢†åŸŸäº‹ä»¶
        domainEvents.add(new DebtSettledEvent(this.id, orderId, period, actualPaid));

        // 6. æ£€æŸ¥åˆåŒæ˜¯å¦å®Œç»“
        checkContractCompletion();

        return true;
    }
}
```

### 3. åº”ç”¨æœåŠ¡ - DebtSettlementAppService

```java
/**
 * åŒ–å€ºåº”ç”¨æœåŠ¡
 * èŒè´£ï¼šç¼–æ’é¢†åŸŸå¯¹è±¡ã€äº‹åŠ¡ç®¡ç†ã€å‘å¸ƒäº‹ä»¶
 * åŸåˆ™ï¼šè–„æœåŠ¡å±‚ï¼Œä¸åŒ…å«ä¸šåŠ¡é€»è¾‘
 */
@Service
public class DebtSettlementAppService {

    @Transactional(rollbackFor = Exception.class)
    public boolean settleDebt(SettleDebtCommand command) {
        // 1. æŸ¥è¯¢åˆ†è´¦é‡‘é¢
        Money divideAmount = divideRecordRepository.getSupplierDivideAmount(command.getOrderNumber());

        // 2. æŸ¥è¯¢å€ºåŠ¡åˆåŒ
        DebtContract contract = debtContractRepository.findByMemberUserId(command.getMemberUserId())
                .orElseThrow(() -> new BusinessException("æœªæ‰¾åˆ°å€ºåŠ¡åˆåŒ"));

        // 3. æ‰§è¡ŒåŒ–å€ºï¼ˆæ ¸å¿ƒé€»è¾‘åœ¨èšåˆæ ¹å†…ï¼‰
        boolean settled = contract.settleDebt(orderId, divideAmount, command.getOrderCreateTime());

        // 4. ä¿å­˜åˆåŒ
        debtContractRepository.save(contract);

        // 5. å‘å¸ƒé¢†åŸŸäº‹ä»¶
        publishDomainEvents(contract.getAndClearDomainEvents());

        return settled;
    }
}
```

### 4. å•å…ƒæµ‹è¯•

```java
@DisplayName("DebtContract èšåˆæ ¹æµ‹è¯•")
class DebtContractTest {

    @Test
    @DisplayName("æ­£å¸¸åŒ–å€º - æœŸæ•°åŒ¹é…")
    void settleDebt_matchedPeriod_shouldSucceed() {
        // Given
        DebtContract contract = new DebtContract(1L, 100L, Money.ofYuan("12000"));
        contract.addRepaymentPlan(Period.of(2025, 3), Money.ofYuan("1000"));

        // When
        boolean result = contract.settleDebt(
            OrderId.of("ORDER001"),
            Money.ofYuan("500"),
            LocalDate.of(2025, 3, 15)
        );

        // Then
        assertTrue(result);
        assertEquals(Money.ofYuan("500"), contract.getPaidTotalAmount());

        List<DomainEvent> events = contract.getAndClearDomainEvents();
        assertEquals(1, events.size());
        assertInstanceOf(DebtSettledEvent.class, events.get(0));
    }
}
```

## ğŸ¯ è®¾è®¡äº®ç‚¹

### 1. å……è¡€æ¨¡å‹ vs è´«è¡€æ¨¡å‹

| è´«è¡€æ¨¡å‹ï¼ˆä¼ ç»Ÿä¸‰å±‚ï¼‰ | å……è¡€æ¨¡å‹ï¼ˆDDDï¼‰ |
|---------------------|----------------|
| å®ä½“åªæœ‰ getter/setter | å®ä½“åŒ…å«ä¸šåŠ¡è¡Œä¸º |
| ä¸šåŠ¡é€»è¾‘åœ¨ Service å±‚ | ä¸šåŠ¡é€»è¾‘åœ¨èšåˆæ ¹å†… |
| éš¾ä»¥ä¿è¯æ•°æ®ä¸€è‡´æ€§ | èšåˆè¾¹ç•Œä¿è¯ä¸€è‡´æ€§ |
| éš¾ä»¥å•å…ƒæµ‹è¯• | é¢†åŸŸå±‚å¯ç‹¬ç«‹æµ‹è¯• |

### 2. å€¼å¯¹è±¡çš„ä»·å€¼

- **Money**ï¼šå°è£…é‡‘é¢è®¡ç®—é€»è¾‘ï¼Œé¿å…ç²¾åº¦é—®é¢˜
- **OrderId**ï¼šæ”¯æŒè®¢å•çº§å’Œå•†å“çº§ä¸¤ç§ç²’åº¦
- **Period**ï¼šå°è£…æœŸæ•°ï¼ˆå¹´æœˆï¼‰æ¦‚å¿µï¼Œç®€åŒ–åŒ¹é…é€»è¾‘

### 3. é˜²è…å±‚éš”ç¦»

```java
// é˜²è…å±‚æ¥å£
public interface CaseEntrustQueryService {
    Optional<Long> getCaseEntrustIdByOrderNumber(String orderNumber);
}

// é¢†åŸŸå±‚ä¸æ„ŸçŸ¥å¤–éƒ¨ç³»ç»Ÿç»†èŠ‚
// å¤–éƒ¨ç³»ç»Ÿå˜æ›´åªéœ€ä¿®æ”¹é˜²è…å±‚å®ç°
```

### 4. é¢†åŸŸäº‹ä»¶é©±åŠ¨

```java
// åŒ–å€ºå®Œæˆåå‘å¸ƒäº‹ä»¶
domainEvents.add(new DebtSettledEvent(contractId, orderId, period, amount));

// å…¶ä»–æ¨¡å—å¯è®¢é˜…äº‹ä»¶ï¼Œå®ç°è§£è€¦
@EventListener
public void onDebtSettled(DebtSettledEvent event) {
    // å‘é€é€šçŸ¥ã€æ›´æ–°ç»Ÿè®¡ç­‰
}
```

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [01-äº‹ä»¶é£æš´](docs/01-äº‹ä»¶é£æš´.md) - é¢†åŸŸäº‹ä»¶è¯†åˆ«ã€å‘½ä»¤æ¸…å•ã€æ—¶åºå›¾
- [02-é¢†åŸŸæ¨¡å‹](docs/02-é¢†åŸŸæ¨¡å‹.md) - èšåˆè®¾è®¡ã€å€¼å¯¹è±¡ã€é¢†åŸŸæœåŠ¡
- [03-åº”ç”¨å±‚è®¾è®¡](docs/03-åº”ç”¨å±‚è®¾è®¡.md) - CQRSã€åº”ç”¨æœåŠ¡ã€DTO è®¾è®¡
- [04-é˜²è…å±‚è®¾è®¡](docs/04-é˜²è…å±‚è®¾è®¡.md) - å¤–éƒ¨ç³»ç»Ÿéš”ç¦»ã€æ¥å£è®¾è®¡

## ğŸ“ æŠ€æœ¯æ ˆ

- Java 17
- Spring Boot 3.x
- MyBatis Plus
- JUnit 5

## ğŸ™‹ å…³äºä½œè€…

æœ¬é¡¹ç›®æ˜¯æˆ‘åœ¨å®é™…å·¥ä½œä¸­å¯¹ DDD çš„å®è·µæ€»ç»“ã€‚åŸç³»ç»Ÿé‡‡ç”¨ä¼ ç»Ÿ MVC æ¶æ„ï¼Œåœ¨ä¸šåŠ¡å¤æ‚åº¦å¢é•¿åå‡ºç°äº†åˆ†å¸ƒå¼ä¸€è‡´æ€§ã€ä»£ç å¯ç»´æŠ¤æ€§ç­‰é—®é¢˜ã€‚é€šè¿‡ DDD é‡æ„ï¼Œå®ç°äº†ï¼š

- ä¸šåŠ¡é€»è¾‘å†…èšï¼Œä»£ç å¯æµ‹è¯•æ€§æå‡
- æ¸…æ™°çš„æ¨¡å—è¾¹ç•Œï¼Œå›¢é˜Ÿåä½œæ›´é¡ºç•…
- æ”¯æŒå•†å“çº§ç²¾ç¡®é€€æ¬¾ï¼Œæ»¡è¶³ä¸šåŠ¡éœ€æ±‚

**æ³¨**ï¼šæœ¬ä»“åº“ä¸ºè„±æ•åçš„å­¦ä¹ ç‰ˆæœ¬ï¼Œä»…å±•ç¤ºæ¶æ„è®¾è®¡æ€è·¯å’Œæ ¸å¿ƒä»£ç å®ç°ã€‚

## ğŸ“„ License

MIT License
