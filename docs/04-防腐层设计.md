# 化债核心域 - 防腐层设计

> 版本: v1.0
> 日期: 2025-11-27

---

## 1. 防腐层概述

### 1.1 什么是防腐层 (ACL)

防腐层 (Anti-Corruption Layer) 是 DDD 中用于**隔离外部系统对领域模型污染**的模式。

**作用**：
- 将外部系统的数据模型转换为领域模型
- 封装外部API调用细节
- 隔离外部系统变更对核心域的影响
- 提供统一的错误处理和重试机制

### 1.2 本项目需要隔离的外部系统

| 外部系统 | 当前实现方式 | 需要隔离的原因 |
|----------|-------------|---------------|
| 会员系统 | SocialUserApi (RPC) | 查询逻辑复杂，需要多表关联 |
| 委案系统 | CaseEntrustMapper (SQL) | 跨多表JOIN查询 |
| 商户系统 | 多个Mapper | 供应商/债务人商户号查询逻辑不同 |
| 易宝支付 | YOP SDK | 第三方API，需要隔离SDK细节 |

---

## 2. 防腐层接口设计

### 2.1 会员查询服务

```java
/**
 * 会员查询服务接口 (防腐层)
 *
 * 隔离会员系统的查询逻辑
 * 原实现: UserMappingServiceImpl -> SocialUserApi
 */
public interface MemberQueryService {

    /**
     * 通过unionId查询会员用户ID
     *
     * 原路径: unionId -> socialUserId -> userId -> memberUserId
     *
     * @param unionId 微信unionId
     * @return 管家系统会员ID，未找到返回null
     */
    Long getMemberUserIdByUnionId(String unionId);

    /**
     * 通过会员ID查询会员信息
     *
     * @param memberUserId 会员用户ID
     * @return 会员信息DTO
     */
    MemberInfo getMemberInfo(Long memberUserId);
}

/**
 * 会员信息 (防腐层DTO)
 *
 * 只包含化债核心域需要的字段
 */
@Data
public class MemberInfo {
    /** 会员用户ID */
    private Long memberUserId;
    /** 用户名 */
    private String username;
    /** 手机号 */
    private String phone;
}
```

### 2.2 委案查询服务

```java
/**
 * 委案查询服务接口 (防腐层)
 *
 * 隔离委案系统的复杂查询
 * 原实现: CaseEntrustMapper.selectCaseEntrustByOrderNumber (多表JOIN)
 */
public interface CaseEntrustQueryService {

    /**
     * 通过订单号查询委案信息
     *
     * 原SQL路径:
     * yb_pay_share_profits (订单号)
     * -> case_overdue_account_applyment (商户号关联)
     * -> case_entrust (委案)
     * -> contract_basic_info (合同状态=in_performance)
     *
     * @param orderId 商城订单号
     * @return 委案信息，未找到返回null
     */
    CaseEntrustInfo findByOrderId(String orderId);

    /**
     * 通过会员ID查询履约中的委案
     *
     * @param memberUserId 会员用户ID
     * @return 委案信息列表
     */
    List<CaseEntrustInfo> findInPerformanceCases(Long memberUserId);

    /**
     * 获取权重最高的委案ID
     *
     * 原实现: ContractApi.getHighestWeightEntrustCaseId
     *
     * @param memberUserId 会员用户ID
     * @return 委案ID
     */
    Long getHighestWeightCaseEntrustId(Long memberUserId);
}

/**
 * 委案信息 (防腐层DTO)
 */
@Data
@Builder
public class CaseEntrustInfo {
    /** 委案ID */
    private Long id;
    /** 案件编号 */
    private String caseNumber;
    /** 债务人姓名 */
    private String debtorName;
    /** 会员用户ID */
    private Long memberUserId;
    /** 合同状态 */
    private String contractStatus;
}
```

### 2.3 商户查询服务

```java
/**
 * 商户查询服务接口 (防腐层)
 *
 * 统一供应商和债务人的商户号查询
 * 原实现分散在: EbMerchantApplymentsMapper, XwAccountApplymentMapper, MerchantAccessAuthInfoMapper
 */
public interface MerchantQueryService {

    /**
     * 获取易宝子商户号
     *
     * 供应商: ledgerId=mer_id -> eb_merchant_applyments.merchant_no
     * 债务人: ledgerId=unionId -> 复杂路径查询 -> xw_account_applyment.merchant_no
     *
     * @param ledgerId 分账标识 (供应商为mer_id，债务人为unionId)
     * @param merType 商户类型
     * @return 易宝子商户号
     */
    String getSubMerNo(String ledgerId, MerType merType);

    /**
     * 获取商户名称
     *
     * @param ledgerId 分账标识
     * @param merType 商户类型
     * @return 商户名称
     */
    String getMerName(String ledgerId, MerType merType);

    /**
     * 批量获取商户信息
     *
     * @param requests 查询请求列表
     * @return 商户信息列表
     */
    List<MerchantInfo> batchGetMerchantInfo(List<MerchantQueryRequest> requests);
}

/**
 * 商户查询请求
 */
@Data
@Builder
public class MerchantQueryRequest {
    private String ledgerId;
    private MerType merType;
}

/**
 * 商户信息 (防腐层DTO)
 */
@Data
@Builder
public class MerchantInfo {
    /** 分账标识 */
    private String ledgerId;
    /** 商户类型 */
    private MerType merType;
    /** 易宝子商户号 */
    private String subMerNo;
    /** 商户名称 */
    private String merName;
    /** 是否有效 */
    private boolean valid;
    /** 无效原因 */
    private String invalidReason;
}
```

### 2.4 易宝分账服务

```java
/**
 * 易宝分账服务接口 (防腐层)
 *
 * 封装易宝YOP SDK的调用细节
 * 原实现: CrmebPreDivideServiceImpl.sendYeepayDivide
 */
public interface YeepayDivideService {

    /**
     * 申请分账
     *
     * @param request 分账请求
     * @return 分账结果
     */
    YeepayDivideResult applyDivide(YeepayDivideRequest request);

    /**
     * 完成分账
     *
     * @param request 完成请求
     * @return 完成结果
     */
    YeepayDivideResult completeDivide(YeepayCompleteRequest request);

    /**
     * 查询分账结果
     *
     * @param orderId 订单号
     * @return 分账结果
     */
    YeepayDivideResult queryDivide(String orderId);
}

/**
 * 易宝分账请求
 */
@Data
@Builder
public class YeepayDivideRequest {
    /** 业务订单号 */
    private String orderId;
    /** 渠道唯一订单号 (易宝要求) */
    private String uniqueOrderNo;
    /** 分账明细 */
    private List<YeepayDivideDetail> divideDetails;
}

/**
 * 易宝分账明细
 */
@Data
@Builder
public class YeepayDivideDetail {
    /** 分账接收方商户号 */
    private String ledgerNo;
    /** 分账金额 */
    private BigDecimal amount;
    /** 分账描述 */
    private String desc;
}

/**
 * 易宝分账结果
 */
@Data
@Builder
public class YeepayDivideResult {
    /** 是否成功 */
    private boolean success;
    /** 批次号 */
    private String batchNo;
    /** 分账明细结果 */
    private List<YeepayDivideDetailResult> detailResults;
    /** 错误码 */
    private String errorCode;
    /** 错误信息 */
    private String errorMsg;
}

/**
 * 易宝分账明细结果
 */
@Data
@Builder
public class YeepayDivideDetailResult {
    /** 分账明细号 */
    private String divideDetailNo;
    /** 分账接收方商户号 */
    private String ledgerNo;
    /** 分账金额 */
    private BigDecimal amount;
    /** 状态 */
    private String status;
}
```

### 2.5 订单查询服务

```java
/**
 * 订单查询服务接口 (防腐层)
 *
 * 隔离商城订单系统的查询
 */
public interface OrderQueryService {

    /**
     * 通过订单号查询渠道唯一订单号
     *
     * 易宝分账需要 uniqueOrderNo
     *
     * @param orderId 业务订单号
     * @return 渠道唯一订单号
     */
    String getUniqueOrderNo(String orderId);

    /**
     * 更新订单的分账请求ID
     *
     * @param orderId 订单号
     * @param divideRequestId 分账请求ID
     */
    void updateDivideRequestId(String orderId, Long divideRequestId);
}
```

---

## 3. 防腐层实现

### 3.1 会员查询服务实现

```java
/**
 * 会员查询服务实现
 *
 * 复用现有 SocialUserApi
 */
@Service
@Slf4j
@RequiredArgsConstructor
public class MemberQueryServiceImpl implements MemberQueryService {

    private final SocialUserApi socialUserApi;

    @Override
    public Long getMemberUserIdByUnionId(String unionId) {
        if (unionId == null || unionId.isBlank()) {
            return null;
        }

        try {
            var result = socialUserApi.getMemberUserIdByUnionid(unionId);
            if (result == null || result.getData() == null) {
                log.warn("[防腐层] 未找到unionId对应的会员: unionId={}", unionId);
                return null;
            }
            return result.getData();
        } catch (Exception e) {
            log.error("[防腐层] 查询会员异常: unionId={}", unionId, e);
            return null;
        }
    }

    @Override
    public MemberInfo getMemberInfo(Long memberUserId) {
        // 根据实际需要实现
        return null;
    }
}
```

### 3.2 委案查询服务实现

```java
/**
 * 委案查询服务实现
 *
 * 封装复杂的多表JOIN查询
 */
@Service
@Slf4j
@RequiredArgsConstructor
public class CaseEntrustQueryServiceImpl implements CaseEntrustQueryService {

    private final CaseEntrustMapper caseEntrustMapper;
    private final ContractApi contractApi;

    @Override
    public CaseEntrustInfo findByOrderId(String orderId) {
        if (orderId == null || orderId.isBlank()) {
            return null;
        }

        try {
            // 复用现有Mapper方法
            CaseEntrustDO caseEntrust = caseEntrustMapper.selectCaseEntrustByOrderNumber(orderId);
            if (caseEntrust == null) {
                log.warn("[防腐层] 未找到订单对应的委案: orderId={}", orderId);
                return null;
            }

            // 转换为防腐层DTO
            return CaseEntrustInfo.builder()
                .id(caseEntrust.getId())
                .caseNumber(caseEntrust.getCaseNumber())
                .debtorName(caseEntrust.getDebtorName())
                .build();

        } catch (Exception e) {
            log.error("[防腐层] 查询委案异常: orderId={}", orderId, e);
            return null;
        }
    }

    @Override
    public List<CaseEntrustInfo> findInPerformanceCases(Long memberUserId) {
        // 根据实际需要实现
        return Collections.emptyList();
    }

    @Override
    public Long getHighestWeightCaseEntrustId(Long memberUserId) {
        try {
            var result = contractApi.getHighestWeightEntrustCaseId(memberUserId);
            return result == null ? null : result.getCheckedData();
        } catch (Exception e) {
            log.error("[防腐层] 查询最高权重委案异常: memberUserId={}", memberUserId, e);
            return null;
        }
    }
}
```

### 3.3 商户查询服务实现

```java
/**
 * 商户查询服务实现
 *
 * 统一供应商和债务人的查询逻辑
 */
@Service
@Slf4j
@RequiredArgsConstructor
public class MerchantQueryServiceImpl implements MerchantQueryService {

    private final EbMerchantApplymentsMapper ebMerchantApplymentsMapper;
    private final XwAccountApplymentMapper xwAccountApplymentMapper;
    private final MerchantAccessAuthInfoMapper merchantAccessAuthInfoMapper;
    private final SocialUserApi socialUserApi;
    private final SocialUserBindApi socialUserBindApi;
    private final CaseEntrustQueryService caseEntrustQueryService;

    @Override
    public String getSubMerNo(String ledgerId, MerType merType) {
        MerchantInfo info = getMerchantInfo(ledgerId, merType);
        return info != null && info.isValid() ? info.getSubMerNo() : null;
    }

    @Override
    public String getMerName(String ledgerId, MerType merType) {
        MerchantInfo info = getMerchantInfo(ledgerId, merType);
        return info != null && info.isValid() ? info.getMerName() : null;
    }

    @Override
    public List<MerchantInfo> batchGetMerchantInfo(List<MerchantQueryRequest> requests) {
        return requests.stream()
            .map(req -> getMerchantInfo(req.getLedgerId(), req.getMerType()))
            .collect(Collectors.toList());
    }

    private MerchantInfo getMerchantInfo(String ledgerId, MerType merType) {
        if (ledgerId == null || ledgerId.isBlank()) {
            return MerchantInfo.builder()
                .ledgerId(ledgerId)
                .merType(merType)
                .valid(false)
                .invalidReason("ledgerId为空")
                .build();
        }

        try {
            if (merType == MerType.SUPPLIER) {
                return getSupplierMerchantInfo(ledgerId);
            } else {
                return getDebtorMerchantInfo(ledgerId);
            }
        } catch (Exception e) {
            log.error("[防腐层] 查询商户信息异常: ledgerId={}, merType={}", ledgerId, merType, e);
            return MerchantInfo.builder()
                .ledgerId(ledgerId)
                .merType(merType)
                .valid(false)
                .invalidReason("查询异常: " + e.getMessage())
                .build();
        }
    }

    /**
     * 查询供应商商户信息
     * ledgerId = mer_id
     */
    private MerchantInfo getSupplierMerchantInfo(String ledgerId) {
        Long merId;
        try {
            merId = Long.valueOf(ledgerId);
        } catch (NumberFormatException e) {
            return MerchantInfo.builder()
                .ledgerId(ledgerId)
                .merType(MerType.SUPPLIER)
                .valid(false)
                .invalidReason("mer_id格式错误")
                .build();
        }

        EbMerchantApplymentsDO apply = ebMerchantApplymentsMapper.selectOne(
            new LambdaQueryWrapperX<EbMerchantApplymentsDO>()
                .eq(EbMerchantApplymentsDO::getMerId, merId)
                .last("limit 1")
        );

        if (apply == null || apply.getMerchantNo() == null) {
            return MerchantInfo.builder()
                .ledgerId(ledgerId)
                .merType(MerType.SUPPLIER)
                .valid(false)
                .invalidReason("供应商未入网: mer_id=" + merId)
                .build();
        }

        return MerchantInfo.builder()
            .ledgerId(ledgerId)
            .merType(MerType.SUPPLIER)
            .subMerNo(apply.getMerchantNo())
            .merName(apply.getMerName())
            .valid(true)
            .build();
    }

    /**
     * 查询债务人商户信息
     * ledgerId = unionId
     *
     * 路径: unionId -> socialUserId -> userId -> caseEntrustId -> xw_account_applyment
     */
    private MerchantInfo getDebtorMerchantInfo(String ledgerId) {
        // 1. unionId -> socialUserId
        Long socialUserId = socialUserApi.getSocialUserIdByUnionid(ledgerId).getCheckedData();
        if (socialUserId == null) {
            return invalidDebtorInfo(ledgerId, "未找到社交用户");
        }

        // 2. socialUserId -> userId
        Long userId = socialUserBindApi.getUserIdByUserTypeAndSocialUserId(
            UserTypeEnum.MEMBER.getValue(), socialUserId
        ).getCheckedData();
        if (userId == null) {
            return invalidDebtorInfo(ledgerId, "社交用户未绑定会员");
        }

        // 3. userId -> caseEntrustId (最高权重)
        Long caseEntrustId = caseEntrustQueryService.getHighestWeightCaseEntrustId(userId);
        if (caseEntrustId == null) {
            return invalidDebtorInfo(ledgerId, "未找到债务人的委案");
        }

        // 4. caseEntrustId + userId -> xw_account_applyment
        XwAccountApplymentDO applyment = xwAccountApplymentMapper.selectOne(
            new LambdaQueryWrapperX<XwAccountApplymentDO>()
                .eq(XwAccountApplymentDO::getCaseId, caseEntrustId)
                .eq(XwAccountApplymentDO::getMemberUserId, userId)
                .last("limit 1")
        );

        if (applyment == null || applyment.getMerchantNo() == null) {
            return invalidDebtorInfo(ledgerId, "债务人未入网");
        }

        // 5. 查询商户名称
        MerchantAccessAuthInfoDO auth = merchantAccessAuthInfoMapper.selectOne(
            new LambdaQueryWrapperX<MerchantAccessAuthInfoDO>()
                .eq(MerchantAccessAuthInfoDO::getMerchantNo, applyment.getMerchantNo())
                .last("limit 1")
        );

        String merName = auth != null ? auth.getSignName() : null;

        return MerchantInfo.builder()
            .ledgerId(ledgerId)
            .merType(MerType.DEBTOR)
            .subMerNo(applyment.getMerchantNo())
            .merName(merName)
            .valid(true)
            .build();
    }

    private MerchantInfo invalidDebtorInfo(String ledgerId, String reason) {
        return MerchantInfo.builder()
            .ledgerId(ledgerId)
            .merType(MerType.DEBTOR)
            .valid(false)
            .invalidReason(reason)
            .build();
    }
}
```

### 3.4 易宝分账服务实现

```java
/**
 * 易宝分账服务实现
 *
 * 封装YOP SDK调用
 */
@Service
@Slf4j
@RequiredArgsConstructor
public class YeepayDivideServiceImpl implements YeepayDivideService {

    private final YeepayProperties yeepayProperties;
    private final ObjectMapper objectMapper;

    @Override
    public YeepayDivideResult applyDivide(YeepayDivideRequest request) {
        try {
            // 1. 构建易宝请求
            ApplyRequest applyReq = buildApplyRequest(request);

            // 2. 调用SDK
            DivideClient client = DivideClientBuilder.builder().build();
            log.info("[防腐层] 发送易宝分账申请: orderId={}", request.getOrderId());
            ApplyResponse response = client.apply(applyReq);

            // 3. 解析响应
            return parseApplyResponse(response);

        } catch (Exception e) {
            log.error("[防腐层] 易宝分账申请异常: orderId={}", request.getOrderId(), e);
            return YeepayDivideResult.builder()
                .success(false)
                .errorCode("SYSTEM_ERROR")
                .errorMsg("系统异常: " + e.getMessage())
                .build();
        }
    }

    @Override
    public YeepayDivideResult completeDivide(YeepayCompleteRequest request) {
        try {
            CompleteRequest completeReq = new CompleteRequest();
            completeReq.setParentMerchantNo(yeepayProperties.getParentMerchantNo());
            completeReq.setMerchantNo(yeepayProperties.getMerchantNo());
            completeReq.setOrderId(request.getOrderId());
            completeReq.setUniqueOrderNo(request.getUniqueOrderNo());
            completeReq.setDivideRequestId(IdUtil.fastSimpleUUID());

            DivideClient client = DivideClientBuilder.builder().build();
            log.info("[防腐层] 发送易宝分账完结: orderId={}", request.getOrderId());
            CompleteResponse response = client.complete(completeReq);

            return parseCompleteResponse(response);

        } catch (Exception e) {
            log.error("[防腐层] 易宝分账完结异常: orderId={}", request.getOrderId(), e);
            return YeepayDivideResult.builder()
                .success(false)
                .errorCode("SYSTEM_ERROR")
                .errorMsg("系统异常: " + e.getMessage())
                .build();
        }
    }

    @Override
    public YeepayDivideResult queryDivide(String orderId) {
        // 根据实际需要实现
        return null;
    }

    private ApplyRequest buildApplyRequest(YeepayDivideRequest request) {
        ApplyRequest applyReq = new ApplyRequest();
        applyReq.setParentMerchantNo(yeepayProperties.getParentMerchantNo());
        applyReq.setMerchantNo(yeepayProperties.getMerchantNo());
        applyReq.setOrderId(request.getOrderId());
        applyReq.setUniqueOrderNo(request.getUniqueOrderNo());
        applyReq.setDivideRequestId(String.valueOf(System.currentTimeMillis()));

        // 构建分账明细JSON
        String divideDetailJson = buildDivideDetailJson(request.getDivideDetails());
        applyReq.setDivideDetail(divideDetailJson);

        return applyReq;
    }

    private String buildDivideDetailJson(List<YeepayDivideDetail> details) {
        StringBuilder sb = new StringBuilder("[");
        for (int i = 0; i < details.size(); i++) {
            if (i > 0) sb.append(",");
            YeepayDivideDetail d = details.get(i);
            sb.append("{")
              .append("\"amount\":\"").append(d.getAmount().stripTrailingZeros().toPlainString()).append("\",")
              .append("\"ledgerNo\":\"").append(d.getLedgerNo()).append("\",")
              .append("\"ledgerType\":\"MERCHANT2MERCHANT\",")
              .append("\"divideDetailDesc\":\"").append(d.getDesc() != null ? d.getDesc() : "商城消费分账").append("\"")
              .append("}");
        }
        sb.append("]");
        return sb.toString();
    }

    private YeepayDivideResult parseApplyResponse(ApplyResponse response) {
        // 解析响应逻辑...
        // 简化示例
        if (response == null || response.getResult() == null) {
            return YeepayDivideResult.builder()
                .success(false)
                .errorCode("EMPTY_RESPONSE")
                .errorMsg("响应为空")
                .build();
        }

        // 实际解析逻辑参考原代码
        return YeepayDivideResult.builder()
            .success(true)
            .build();
    }

    private YeepayDivideResult parseCompleteResponse(CompleteResponse response) {
        // 解析响应逻辑...
        return YeepayDivideResult.builder()
            .success(true)
            .build();
    }
}
```

---

## 4. 防腐层架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              应用层                                          │
│  ┌───────────────────────────┐    ┌───────────────────────────┐            │
│  │  DebtSettlementAppService │    │  PreDivideAppService      │            │
│  └─────────────┬─────────────┘    └─────────────┬─────────────┘            │
│                │                                │                           │
└────────────────┼────────────────────────────────┼───────────────────────────┘
                 │                                │
                 │  ┌─────────────────────────────┼────────────────────┐
                 │  │                             │                    │
                 ▼  ▼                             ▼                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              防腐层 (ACL)                                    │
│                                                                             │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐             │
│  │ MemberQuery     │  │ CaseEntrust     │  │ MerchantQuery   │             │
│  │ Service         │  │ QueryService    │  │ Service         │             │
│  │                 │  │                 │  │                 │             │
│  │ 接口定义        │  │ 接口定义        │  │ 接口定义        │             │
│  │ ↓              │  │ ↓              │  │ ↓              │             │
│  │ MemberQuery     │  │ CaseEntrust     │  │ MerchantQuery   │             │
│  │ ServiceImpl     │  │ QueryServiceImpl│  │ ServiceImpl     │             │
│  └────────┬────────┘  └────────┬────────┘  └────────┬────────┘             │
│           │                    │                    │                       │
│  ┌─────────────────┐  ┌─────────────────┐                                  │
│  │ YeepayDivide    │  │ OrderQuery      │                                  │
│  │ Service         │  │ Service         │                                  │
│  └────────┬────────┘  └────────┬────────┘                                  │
│           │                    │                                            │
└───────────┼────────────────────┼────────────────────────────────────────────┘
            │                    │
            ▼                    ▼
┌───────────────────────────────────────────────────────────────────────────┐
│                           外部系统/现有代码                                 │
│                                                                           │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐      │
│  │ SocialUser  │  │ CaseEntrust │  │ Merchant    │  │ Order       │      │
│  │ Api (RPC)   │  │ Mapper      │  │ Mappers     │  │ Mapper      │      │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘      │
│                                                                           │
│  ┌─────────────────────────────────────────────────────────────────────┐  │
│  │                          易宝 YOP SDK                                │  │
│  │  DivideClient.apply()  /  DivideClient.complete()                   │  │
│  └─────────────────────────────────────────────────────────────────────┘  │
│                                                                           │
└───────────────────────────────────────────────────────────────────────────┘
```

---

## 5. 防腐层的价值

### 5.1 对比：有防腐层 vs 无防腐层

**无防腐层（现有代码）**:
```java
// OrderServiceImpl.java
// 直接在业务代码中调用各种Mapper和API
userMemberId = userMappingService.getMemberUserIdByUnionId(createReqVO.getUnionId());
caseEntrust = caseEntrustMapper.selectCaseEntrustByOrderNumber(createReqVO.getPlatOrderNo());
divideResult = divideAmountApi.getDivideAmountByOrder(createReqVO.getPlatOrderNo(), 1);
```

问题：
- 业务代码与外部系统强耦合
- 外部API变更需要修改业务代码
- 难以单元测试

**有防腐层（重构后）**:
```java
// DebtSettlementAppService.java
// 通过防腐层接口调用，隔离外部系统
Long memberUserId = memberQueryService.getMemberUserIdByUnionId(command.getUnionId());
CaseEntrustInfo caseEntrust = caseEntrustQueryService.findByOrderId(command.getOrderId());
Money divideAmount = queryDivideAmount(command.getOrderId(), command.getOrderDetailId());
```

优势：
- 领域层不感知外部系统细节
- 外部API变更只需修改防腐层实现
- 易于Mock测试

### 5.2 面试话术

> **面试官问**：你在项目中如何处理与外部系统的交互？
>
> **回答**：我使用了DDD中的防腐层模式。比如我们的化债核心域需要查询会员信息、委案信息、调用易宝分账API。我定义了`MemberQueryService`、`CaseEntrustQueryService`、`YeepayDivideService`等接口作为防腐层，将外部系统的复杂查询逻辑封装在实现类中。这样做的好处是：
> 1. 领域层代码干净，不包含外部API调用细节
> 2. 外部系统变更只需修改防腐层，不影响核心业务逻辑
> 3. 单元测试时可以轻松Mock防腐层接口

---

## 6. 下一步

- [ ] 创建代码目录结构
- [ ] 实现核心领域对象（值对象、聚合根）
- [ ] 实现仓储层
- [ ] 集成测试
